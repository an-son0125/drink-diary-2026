<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 ç¿Šç¶­é£²æ–™æ—¥è¨˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        :root { --bg-color: #fdf6e3; --theme-color: #f87171; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-color); color: #4a4a4a; transition: background-color 0.3s ease; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .day-cell { aspect-ratio: 1/1; border-radius: 12px; transition: all 0.2s; position: relative; border: 1px solid transparent; font-size: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .day-cell.has-data { background-color: color-mix(in srgb, var(--theme-color), transparent 75%); border: 1px solid color-mix(in srgb, var(--theme-color), transparent 60%); }
        .day-cell.today { border: 2px solid var(--theme-color); font-weight: bold; }
        .chip-btn { border: 1px solid #e5e7eb; color: #6b7280; padding: 6px 14px; border-radius: 9999px; font-size: 12px; background: white; white-space: nowrap; }
        .chip-btn.selected { background-color: var(--theme-color); color: white; border-color: var(--theme-color); }
        .tab-btn { position: relative; padding: 12px 0; font-weight: 700; font-size: 18px; color: #9ca3af; flex: 1; text-align: center; }
        .tab-btn.active { color: var(--theme-color); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 30px; height: 3px; background-color: var(--theme-color); border-radius: 99px; }
        .bg-theme { background-color: var(--theme-color) !important; }
        .loading-overlay { position: fixed; inset: 0; background: white; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden">

    <div id="loading-screen" class="loading-overlay">
        <div class="w-10 h-10 border-4 border-gray-200 border-t-red-400 rounded-full animate-spin"></div>
        <p class="mt-4 text-xs font-bold text-gray-400 tracking-widest">é›²ç«¯è³‡æ–™åŒæ­¥ä¸­...</p>
    </div>

    <div class="flex-none p-4 pb-0 z-10">
        <div class="flex justify-between items-center mb-3">
            <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <span class="bg-theme text-white p-1.5 rounded-lg w-10 h-10 flex items-center justify-center shadow-sm">
                    <i class="fas fa-heart text-xl"></i>
                </span>
                <div class="flex flex-col">
                    <span class="leading-tight">2026 ç¿Šç¶­é£²æ–™æ—¥è¨˜</span>
                    <span class="text-[9px] text-green-600 font-bold uppercase tracking-widest">Cloud Sync</span>
                </div>
            </h1>
            <button onclick="toggleSettings()" class="w-9 h-9 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-400"><i class="fas fa-cog"></i></button>
        </div>

        <div class="grid grid-cols-2 gap-2 mb-3">
            <div class="bg-white/80 backdrop-blur p-2 rounded-xl border border-white/50 shadow-sm">
                <div class="text-[9px] text-gray-400 font-bold tracking-wider mb-0.5">æœ¬æœˆç´¯ç©æ¯æ•¸</div>
                <span class="text-lg font-bold text-theme" id="month-cups">0</span>
            </div>
            <div class="bg-white/80 backdrop-blur p-2 rounded-xl border border-white/50 shadow-sm">
                <div class="text-[9px] text-gray-400 font-bold tracking-wider mb-0.5">æœ¬æœˆç´¯ç©ç¸½é¡</div>
                <span class="text-lg font-bold text-gray-700">$<span id="month-cost">0</span></span>
            </div>
        </div>

        <div class="flex border-b border-gray-100">
            <button onclick="switchView('calendar')" id="tab-calendar" class="tab-btn active text-2xl">ğŸ¥¤</button>
            <button onclick="switchView('list')" id="tab-list" class="tab-btn">æ¸…å–®</button>
        </div>
    </div>

    <div id="calendar-view-container" class="flex flex-col flex-grow overflow-hidden">
        <div class="px-4 py-2 flex items-center justify-between">
            <button onclick="changeMonth(-1)" class="w-8 h-8 text-gray-400"><i class="fas fa-chevron-left"></i></button>
            <h2 class="text-md font-bold text-gray-700" id="current-month-display">...</h2>
            <button onclick="changeMonth(1)" class="w-8 h-8 text-gray-400"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="flex-grow overflow-y-auto px-4 pb-24 no-scrollbar">
            <div class="bg-white rounded-2xl p-3 shadow-sm border border-gray-100 mb-4">
                <div class="grid grid-cols-7 gap-1 mb-2 text-center text-[10px] text-gray-300 font-bold">
                    <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                </div>
                <div class="calendar-grid" id="calendar-grid"></div>
            </div>
        </div>
    </div>

    <div id="list-view-container" class="hidden flex-col flex-grow overflow-hidden px-4">
        <div class="py-3">
            <div class="bg-gray-200/50 p-1 rounded-xl flex gap-1 text-[10px]">
                <button onclick="switchListType('month')" id="subtab-month" class="bg-white text-theme shadow-sm py-2 flex-1 rounded-lg font-bold">ç•¶æœˆæ˜ç´°</button>
                <button onclick="switchListType('year')" id="subtab-year" class="text-gray-400 py-2 flex-1 rounded-lg font-bold">å…¨å¹´åº¦ç´€éŒ„</button>
            </div>
        </div>
        <div class="flex-grow overflow-y-auto pb-24 no-scrollbar" id="list-items-container"></div>
    </div>

    <button onclick="openQuickAdd()" class="fixed bottom-6 right-6 w-14 h-14 bg-theme text-white rounded-full flex items-center justify-center text-2xl z-40 shadow-lg">
        <i class="fas fa-plus"></i>
    </button>

    <div id="entry-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-end sm:items-center justify-center z-50">
        <div class="bg-white w-full sm:w-[450px] rounded-t-2xl sm:rounded-2xl p-5 space-y-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center">
                <h3 class="font-bold text-lg" id="form-date-subtitle">æ–°å¢ç´€éŒ„</h3>
                <button onclick="closeEntryModal()" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <input type="text" id="input-shop" class="w-full bg-gray-50 p-2 rounded border" placeholder="åº—å">
            <input type="text" id="input-item" class="w-full bg-gray-50 p-2 rounded border" placeholder="å“é …">
            <input type="number" id="input-price" class="w-full bg-gray-50 p-2 rounded border" placeholder="åƒ¹æ ¼ ($)">
            <div>
                <label class="text-xs font-bold text-gray-400 mb-2 block">å†°å¡Šé¸æ“‡</label>
                <div id="ice-options" class="flex flex-wrap gap-2"></div>
            </div>
            <div>
                <label class="text-xs font-bold text-gray-400 mb-2 block">ç”œåº¦é¸æ“‡</label>
                <div id="sugar-options" class="flex flex-wrap gap-2"></div>
            </div>
            <button onclick="saveEntry()" class="w-full bg-theme text-white font-bold py-3 rounded-xl">å„²å­˜ç´€éŒ„</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCLwMbIgQaF_KWYNWruOrHDrMopGJFx470",
            authDomain: "drink-diary-2026.firebaseapp.com",
            projectId: "drink-diary-2026",
            storageBucket: "drink-diary-2026.firebasestorage.app",
            messagingSenderId: "994141313696",
            appId: "1:994141313696:web:d14b3a97541fa6e0e207c5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'drink-diary-2026';

        window.drinkDB = {};
        window.currentUser = null;
        let currentMonth = new Date().getMonth();
        let currentViewingDate = '';
        let listType = 'month'; // 'month' or 'year'
        let selectedIce = '', selectedSugar = '';

        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.currentUser = user;
                startSync(user.uid);
            } else {
                signInAnonymously(auth);
            }
        });

        function startSync(uid) {
            const docRef = doc(db, 'artifacts', appId, 'users', uid);
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    window.drinkDB = docSnap.data().records || {};
                }
                renderAll();
                document.getElementById('loading-screen').style.display = 'none';
            });
        }

        window.saveEntry = async () => {
            const shop = document.getElementById('input-shop').value;
            const item = document.getElementById('input-item').value;
            const price = document.getElementById('input-price').value;
            if(!shop || !item) return alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');

            if(!window.drinkDB[currentViewingDate]) window.drinkDB[currentViewingDate] = [];
            window.drinkDB[currentViewingDate].push({ shop, item, price, ice: selectedIce, sugar: selectedSugar });
            
            await setDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid), {
                records: window.drinkDB
            }, { merge: true });
            
            closeEntryModal();
        };

        window.renderAll = () => {
            const monthsNames = ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
            document.getElementById('current-month-display').innerText = `2026å¹´ ${monthsNames[currentMonth]}`;
            renderCalendar();
            renderList();
            updateStats();
        };

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            const firstDay = new Date(2026, currentMonth, 1).getDay();
            const totalDays = new Date(2026, currentMonth + 1, 0).getDate();
            const today = new Date().toISOString().split('T')[0];

            for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));
            
            for(let d=1; d<=totalDays; d++) {
                const ds = `2026-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const records = window.drinkDB[ds] || [];
                const cell = document.createElement('div');
                cell.className = `day-cell ${ds === today ? 'today' : ''} ${records.length > 0 ? 'has-data' : ''}`;
                cell.innerHTML = records.length > 0 ? 'ğŸ¥¤' : d;
                cell.onclick = () => openQuickAdd(ds);
                grid.appendChild(cell);
            }
        }

        function renderList() {
            const container = document.getElementById('list-items-container');
            container.innerHTML = '';
            const mPrefix = `2026-${String(currentMonth+1).padStart(2,'0')}`;
            
            Object.keys(window.drinkDB).sort().reverse().forEach(date => {
                if (listType === 'month' && !date.startsWith(mPrefix)) return;
                
                window.drinkDB[date].forEach(record => {
                    const div = document.createElement('div');
                    div.className = 'bg-white p-3 rounded-xl mb-2 shadow-sm border border-gray-100 flex justify-between items-center';
                    div.innerHTML = `
                        <div>
                            <div class="text-[10px] text-gray-400 font-bold">${date}</div>
                            <div class="font-bold text-gray-700">${record.shop} Â· ${record.item}</div>
                            <div class="text-[10px] text-gray-500">${record.ice} / ${record.sugar}</div>
                        </div>
                        <div class="font-bold text-theme">$${record.price}</div>
                    `;
                    container.appendChild(div);
                });
            });
        }

        function updateStats() {
            let cost = 0, cups = 0;
            const prefix = `2026-${String(currentMonth+1).padStart(2,'0')}`;
            Object.keys(window.drinkDB).forEach(d => {
                if(d.startsWith(prefix)) {
                    window.drinkDB[d].forEach(r => { cost += Number(r.price || 0); cups++; });
                }
            });
            document.getElementById('month-cost').innerText = cost;
            document.getElementById('month-cups').innerText = cups;
        }

        window.switchView = (v) => {
            document.getElementById('calendar-view-container').classList.toggle('hidden', v === 'list');
            document.getElementById('list-view-container').classList.toggle('hidden', v === 'calendar');
            document.getElementById('tab-calendar').classList.toggle('active', v === 'calendar');
            document.getElementById('tab-list').classList.toggle('active', v === 'list');
            renderAll();
        };

        window.switchListType = (type) => {
            listType = type;
            document.getElementById('subtab-month').className = type === 'month' ? 'bg-white text-theme shadow-sm py-2 flex-1 rounded-lg font-bold' : 'text-gray-400 py-2 flex-1 rounded-lg font-bold';
            document.getElementById('subtab-year').className = type === 'year' ? 'bg-white text-theme shadow-sm py-2 flex-1 rounded-lg font-bold' : 'text-gray-400 py-2 flex-1 rounded-lg font-bold';
            renderList();
        };

        window.changeMonth = (d) => { currentMonth = (currentMonth + d + 12) % 12; renderAll(); };
        window.openQuickAdd = (ds) => { 
            currentViewingDate = ds || new Date().toISOString().split('T')[0];
            document.getElementById('form-date-subtitle').innerText = currentViewingDate;
            document.getElementById('entry-modal').classList.remove('hidden'); 
        };
        window.closeEntryModal = () => document.getElementById('entry-modal').classList.add('hidden');

        // é¸é …åˆå§‹åŒ–
        const iceOpts = ['å›ºå®š', 'æ­£å¸¸', 'å°‘å†°', 'å¾®å†°', 'å»å†°', 'å¸¸æº«', 'ç†±'];
        const sugarOpts = ['å›ºå®š', 'å…¨ç³–', 'å°‘ç³–', 'åŠç³–', 'å¾®ç³–', 'ä¸€åˆ†ç³–', 'ç„¡ç³–'];
        const setup = (id, opts, type) => {
            const container = document.getElementById(id);
            opts.forEach(o => {
                const btn = document.createElement('button');
                btn.className = 'chip-btn'; btn.innerText = o;
                btn.onclick = () => {
                    Array.from(container.children).forEach(c => c.classList.remove('selected'));
                    btn.classList.add('selected');
                    if(type==='ice') selectedIce=o; else selectedSugar=o;
                };
                container.appendChild(btn);
            });
        };
        setup('ice-options', iceOpts, 'ice');
        setup('sugar-options', sugarOpts, 'sugar');
    </script>
</body>
</html>
