<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 ÁøäÁ∂≠È£≤ÊñôÊó•Ë®ò</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        :root { --bg-color: #fdf6e3; --theme-color: #f87171; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-color); color: #4a4a4a; transition: background-color 0.3s ease; margin: 0; padding: 0; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .day-cell { aspect-ratio: 1/1; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 13px; position: relative; background: rgba(255,255,255,0.4); border: 1px solid transparent; }
        .day-cell.today { border: 2px solid var(--theme-color); font-weight: bold; }
        .day-cell.has-data { background-color: color-mix(in srgb, var(--theme-color), transparent 70%); border-color: var(--theme-color); }
        .tab-btn { flex: 1; text-align: center; padding: 12px; font-weight: bold; color: #9ca3af; cursor: pointer; }
        .tab-btn.active { color: var(--theme-color); border-bottom: 3px solid var(--theme-color); }
        .chip-btn { border: 1px solid #e5e7eb; padding: 6px 12px; border-radius: 20px; font-size: 12px; background: white; }
        .chip-btn.selected { background: var(--theme-color); color: white; border-color: var(--theme-color); }
        .star-rating i { cursor: pointer; color: #d1d5db; margin: 0 2px; }
        .star-rating i.active { color: #fbbf24; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: flex-end; justify-content: center; z-index: 100; }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 20px; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- Header Stats -->
    <div class="p-4 bg-white/50 backdrop-blur-md">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <span class="bg-red-400 text-white p-2 rounded-lg"><i class="fas fa-mug-hot"></i></span>
                2026 È£≤ÊñôÊó•Ë®ò
            </h1>
            <div class="text-xs font-bold text-gray-400" id="connection-status">Èõ¢Á∑öÊ®°Âºè</div>
        </div>
        <div class="grid grid-cols-2 gap-3">
            <div class="bg-white p-3 rounded-xl shadow-sm border border-orange-100">
                <div class="text-[10px] text-gray-400 uppercase">Êú¨ÊúàÊùØÊï∏</div>
                <div class="text-xl font-bold text-red-400" id="stat-month-count">0</div>
            </div>
            <div class="bg-white p-3 rounded-xl shadow-sm border border-orange-100">
                <div class="text-[10px] text-gray-400 uppercase">Êú¨ÊúàËä±Ë≤ª</div>
                <div class="text-xl font-bold text-gray-700">$<span id="stat-month-cost">0</span></div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="flex border-b">
        <div class="tab-btn active" id="tab-cal" onclick="switchTab('calendar')">Êó•ÊõÜË¶ñÂúñ</div>
        <div class="tab-btn" id="tab-list" onclick="switchTab('list')">Ê≠∑Âè≤Ê∏ÖÂñÆ</div>
    </div>

    <!-- Content -->
    <div class="flex-grow overflow-y-auto p-4 pb-24" id="main-content">
        <div id="calendar-view">
            <div class="flex justify-between items-center mb-4">
                <button onclick="changeMonth(-1)" class="p-2 text-gray-400"><i class="fas fa-chevron-left"></i></button>
                <div class="font-bold text-lg" id="month-label">2026Âπ¥ 1Êúà</div>
                <button onclick="changeMonth(1)" class="p-2 text-gray-400"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="grid grid-cols-7 gap-1 text-center text-[10px] font-bold text-gray-300 mb-2">
                <div>Êó•</div><div>‰∏Ä</div><div>‰∫å</div><div>‰∏â</div><div>Âõõ</div><div>‰∫î</div><div>ÂÖ≠</div>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>
        <div id="list-view" class="hidden space-y-3"></div>
    </div>

    <!-- Quick Add Button -->
    <button onclick="openForm()" class="fixed bottom-6 right-6 w-14 h-14 bg-red-400 text-white rounded-full shadow-lg flex items-center justify-center text-xl z-50">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Entry Modal -->
    <div id="entry-modal" class="modal" onclick="if(event.target===this) closeModal()">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-lg" id="form-title">Êñ∞Â¢ûÁ¥ÄÈåÑ</h3>
                <button onclick="closeModal()" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <input type="text" id="in-shop" class="w-full p-3 bg-gray-50 rounded-xl outline-none border border-transparent focus:border-red-400" placeholder="Â∫óÂêç (‰æã: ÂèØ‰∏çÂèØ)">
                <input type="text" id="in-item" class="w-full p-3 bg-gray-50 rounded-xl outline-none border border-transparent focus:border-red-400" placeholder="ÂìÅÈ†Ö (‰æã: ÁÜüÊàêÁ¥ÖËå∂)">
                <input type="number" id="in-price" class="w-full p-3 bg-gray-50 rounded-xl outline-none border border-transparent focus:border-red-400" placeholder="ÈáëÈ°ç">
                
                <div>
                    <div class="text-xs font-bold text-gray-400 mb-2">ÂÜ∞Â°äÁîúÂ∫¶</div>
                    <div class="flex flex-wrap gap-2 mb-2" id="ice-chips"></div>
                    <div class="flex flex-wrap gap-2" id="sugar-chips"></div>
                </div>

                <div>
                    <div class="text-xs font-bold text-gray-400 mb-2">Ë©ïÂàÜ</div>
                    <div class="star-rating text-2xl" id="star-rating">
                        <i class="fas fa-star" onclick="setRating(1)"></i>
                        <i class="fas fa-star" onclick="setRating(2)"></i>
                        <i class="fas fa-star" onclick="setRating(3)"></i>
                        <i class="fas fa-star" onclick="setRating(4)"></i>
                        <i class="fas fa-star" onclick="setRating(5)"></i>
                    </div>
                </div>
                
                <button onclick="saveEntry()" class="w-full bg-red-400 text-white font-bold py-4 rounded-xl shadow-md mt-4">Á¢∫Ë™çÂÑ≤Â≠ò</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ÂÖ®ÂüüËÆäÊï∏
        window.drinkData = JSON.parse(localStorage.getItem('yiwei_drinks_2026')) || {};
        window.currentMonth = new Date().getMonth(); 
        window.selectedDate = '';
        window.selectedIce = '';
        window.selectedSugar = '';
        window.selectedRating = 0;

        // Firebase ÂÆâÂÖ®Ê™¢Êü•
        let db = null;
        let auth = null;
        const configStr = typeof __firebase_config !== 'undefined' ? __firebase_config : null;

        if (configStr) {
            try {
                const app = initializeApp(JSON.parse(configStr));
                auth = getAuth(app);
                db = getFirestore(app);
                document.getElementById('connection-status').innerText = 'Èõ≤Á´ØÂêåÊ≠•‰∏≠';
                
                signInAnonymously(auth).then(() => {
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            const appId = typeof __app_id !== 'undefined' ? __app_id : 'yi-wei-2026';
                            onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'drinks'), (s) => {
                                if (s.exists()) {
                                    window.drinkData = s.data().records || {};
                                    localStorage.setItem('yiwei_drinks_2026', JSON.stringify(window.drinkData));
                                    window.render();
                                }
                            });
                        }
                    });
                });
            } catch (e) { console.error("Firebase Init Failed", e); }
        }

        // ‰øùÂ≠òÂáΩÊï∏
        window.saveData = async () => {
            localStorage.setItem('yiwei_drinks_2026', JSON.stringify(window.drinkData));
            if (db && auth?.currentUser) {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'yi-wei-2026';
                await setDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'data', 'drinks'), {
                    records: window.drinkData
                });
            }
            window.render();
        };

        // Ê†∏ÂøÉÊ∏≤Êüì
        window.render = () => {
            const grid = document.getElementById('calendar-grid');
            const monthLabel = document.getElementById('month-label');
            if(!grid) return;

            grid.innerHTML = '';
            monthLabel.innerText = `2026Âπ¥ ${window.currentMonth + 1}Êúà`;

            const firstDay = new Date(2026, window.currentMonth, 1).getDay();
            const daysInMonth = new Date(2026, window.currentMonth + 1, 0).getDate();
            const todayStr = new Date().toISOString().split('T')[0];

            // Â°´ÂÖÖÁ©∫ÁôΩ
            for (let i = 0; i < firstDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            let mCount = 0;
            let mCost = 0;

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `2026-${String(window.currentMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const cell = document.createElement('div');
                cell.className = `day-cell ${dateStr === todayStr ? 'today' : ''}`;
                
                const dayRecords = window.drinkData[dateStr] || [];
                if (dayRecords.length > 0) {
                    cell.classList.add('has-data');
                    cell.innerHTML = `ü•§<span class="absolute bottom-1 right-1 text-[8px] opacity-50">${d}</span>`;
                    dayRecords.forEach(r => {
                        mCount++;
                        mCost += Number(r.price || 0);
                    });
                } else {
                    cell.innerText = d;
                }

                cell.onclick = () => window.openForm(dateStr);
                grid.appendChild(cell);
            }

            document.getElementById('stat-month-count').innerText = mCount;
            document.getElementById('stat-month-cost').innerText = mCost;
            renderHistory();
        };

        function renderHistory() {
            const list = document.getElementById('list-view');
            list.innerHTML = '';
            const allDates = Object.keys(window.drinkData).sort().reverse();
            
            if(allDates.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-400 py-10">Â∞öÁÑ°È£≤Áî®Á¥ÄÈåÑ</div>';
                return;
            }

            allDates.forEach(date => {
                window.drinkData[date].forEach((item, idx) => {
                    const card = document.createElement('div');
                    card.className = "bg-white p-4 rounded-xl shadow-sm flex justify-between items-center";
                    card.innerHTML = `
                        <div>
                            <div class="text-[10px] text-gray-400 font-bold">${date}</div>
                            <div class="font-bold text-gray-700">${item.shop} - ${item.item}</div>
                            <div class="text-xs text-gray-400">${item.ice} / ${item.sugar} ¬∑ $${item.price}</div>
                        </div>
                        <button onclick="deleteEntry('${date}', ${idx})" class="text-gray-300 p-2"><i class="fas fa-trash"></i></button>
                    `;
                    list.appendChild(card);
                });
            });
        }

        // ÂàùÂßãÂåñ
        window.render();
    </script>

    <script>
        // ÈùûÊ®°ÁµÑÂåñÂáΩÊï∏
        function switchTab(t) {
            document.getElementById('calendar-view').classList.toggle('hidden', t !== 'calendar');
            document.getElementById('list-view').classList.toggle('hidden', t !== 'list');
            document.getElementById('tab-cal').classList.toggle('active', t === 'calendar');
            document.getElementById('tab-list').classList.toggle('active', t === 'list');
        }

        function changeMonth(dir) {
            window.currentMonth = (window.currentMonth + dir + 12) % 12;
            window.render();
        }

        function openForm(date) {
            window.selectedDate = date || new Date().toISOString().split('T')[0];
            document.getElementById('form-title').innerText = `${window.selectedDate} Á¥ÄÈåÑ`;
            document.getElementById('entry-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('entry-modal').style.display = 'none';
        }

        function setRating(r) {
            window.selectedRating = r;
            const stars = document.getElementById('star-rating').children;
            for(let i=0; i<5; i++) stars[i].classList.toggle('active', i < r);
        }

        function selectChip(type, val, el) {
            const chips = el.parentElement.children;
            for(let c of chips) c.classList.remove('selected');
            el.classList.add('selected');
            if(type === 'ice') window.selectedIce = val;
            else window.selectedSugar = val;
        }

        async function saveEntry() {
            const shop = document.getElementById('in-shop').value;
            const item = document.getElementById('in-item').value;
            const price = document.getElementById('in-price').value;

            if(!shop || !item) {
                alert('Ë´ãÂ°´ÂØ´Â∫óÂêçËàáÂìÅÈ†Ö');
                return;
            }

            const record = {
                shop, item, price,
                ice: window.selectedIce || 'Êú™ÈÅ∏',
                sugar: window.selectedSugar || 'Êú™ÈÅ∏',
                rating: window.selectedRating
            };

            if(!window.drinkData[window.selectedDate]) window.drinkData[window.selectedDate] = [];
            window.drinkData[window.selectedDate].push(record);

            await window.saveData();
            
            // Ê∏ÖÁ©∫ËàáÈóúÈñâ
            document.getElementById('in-shop').value = '';
            document.getElementById('in-item').value = '';
            document.getElementById('in-price').value = '';
            closeModal();
        }

        function deleteEntry(date, idx) {
            if(confirm('Á¢∫ÂÆöÂà™Èô§Ê≠§Á¥ÄÈåÑÔºü')) {
                window.drinkData[date].splice(idx, 1);
                if(window.drinkData[date].length === 0) delete window.drinkData[date];
                window.saveData();
            }
        }

        // ÂàùÂßãÂåñ Chips
        window.onload = () => {
            const ices = ['Ê≠£Â∏∏', 'Â∞ëÂÜ∞', 'ÂæÆÂÜ∞', 'ÂéªÂÜ∞', 'ÁÜ±'];
            const sugars = ['ÂÖ®Á≥ñ', 'ÂçäÁ≥ñ', 'ÂæÆÁ≥ñ', 'ÁÑ°Á≥ñ'];
            
            const iceContainer = document.getElementById('ice-chips');
            const sugarContainer = document.getElementById('sugar-chips');

            ices.forEach(v => {
                const btn = document.createElement('button');
                btn.className = 'chip-btn';
                btn.innerText = v;
                btn.onclick = (e) => selectChip('ice', v, e.target);
                iceContainer.appendChild(btn);
            });

            sugars.forEach(v => {
                const btn = document.createElement('button');
                btn.className = 'chip-btn';
                btn.innerText = v;
                btn.onclick = (e) => selectChip('sugar', v, e.target);
                sugarContainer.appendChild(btn);
            });
        };
    </script>
</body>
</html>
