<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 ç¿Šç¶­é£²æ–™æ—¥è¨˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        :root { --bg-color: #fdf6e3; --theme-color: #f87171; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-color); color: #4a4a4a; transition: all 0.3s ease; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        
        /* æ—¥æ›†æ ¼æ·±æ·ºè®ŠåŒ– */
        .day-cell { aspect-ratio: 1/1; border-radius: 12px; transition: all 0.2s; position: relative; border: 1px solid transparent; font-size: 14px; }
        .day-cell.level-1 { background-color: color-mix(in srgb, var(--theme-color), transparent 85%); }
        .day-cell.level-2 { background-color: color-mix(in srgb, var(--theme-color), transparent 60%); }
        .day-cell.level-3 { background-color: color-mix(in srgb, var(--theme-color), transparent 30%); color: white; }
        .day-cell.today { border: 2px solid var(--theme-color); }
        
        .chip-btn { border: 1px solid #e5e7eb; color: #6b7280; padding: 6px 14px; border-radius: 9999px; font-size: 12px; background: white; white-space: nowrap; }
        .chip-btn.selected { background-color: var(--theme-color); color: white; border-color: var(--theme-color); }
        .tab-btn { position: relative; padding: 12px 0; font-weight: 700; font-size: 18px; color: #9ca3af; flex: 1; text-align: center; }
        .tab-btn.active { color: var(--theme-color); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 30px; height: 3px; background-color: var(--theme-color); border-radius: 99px; }
        
        /* æ»‘å‹•æŒ‰éˆ•å€åŸŸ */
        .swipe-item { position: relative; overflow: hidden; border-radius: 1rem; margin-bottom: 0.75rem; touch-action: pan-x; }
        .swipe-content { position: relative; z-index: 10; background: white; transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .swipe-actions { position: absolute; right: 0; top: 0; height: 100%; display: flex; z-index: 5; }
        .action-btn { width: 70px; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 13px; font-weight: bold; }
        .btn-edit { background: #9ca3af; }
        .btn-delete { background: #ef4444; }

        .bg-theme { background-color: var(--theme-color) !important; }
        .text-theme { color: var(--theme-color) !important; }
        .swatch { width: 28px; height: 28px; border-radius: 8px; cursor: pointer; border: 2px solid white; box-shadow: 0 0 0 1px #e5e7eb; }
        .loading-overlay { position: fixed; inset: 0; background: white; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden">

    <div id="loading-screen" class="loading-overlay">
        <div class="w-10 h-10 border-4 border-gray-200 border-t-red-400 rounded-full animate-spin"></div>
        <p class="mt-4 text-xs font-bold text-gray-400 tracking-widest">è¼‰å…¥ä¸­...</p>
    </div>

    <div class="flex-none p-4 pb-0 z-10">
        <div class="flex justify-between items-center mb-3">
            <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <span class="bg-theme text-white p-1.5 rounded-lg w-10 h-10 flex items-center justify-center shadow-sm transition-all duration-500">
                    <i class="fas fa-mug-hot text-xl"></i>
                </span>
                <div class="flex flex-col">
                    <span class="leading-tight">2026 ç¿Šç¶­é£²æ–™æ—¥è¨˜</span>
                    <span class="text-[9px] text-green-600 font-bold uppercase tracking-widest">Auto Sync</span>
                </div>
            </h1>
            <button onclick="toggleSettings()" class="w-9 h-9 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-400"><i class="fas fa-palette"></i></button>
        </div>

        <div class="grid grid-cols-2 gap-2 mb-3">
            <div class="bg-white/80 backdrop-blur p-2 rounded-xl shadow-sm border border-white/50">
                <div class="text-[9px] text-gray-400 font-bold mb-0.5">æœˆæ¯æ•¸ / æœˆèŠ±è²»</div>
                <div class="flex justify-between items-baseline"><span class="text-lg font-bold text-theme" id="month-cups">0</span><span class="text-sm font-bold text-gray-600">$<span id="month-cost">0</span></span></div>
            </div>
            <div class="bg-white/80 backdrop-blur p-2 rounded-xl shadow-sm border border-white/50">
                <div class="text-[9px] text-gray-400 font-bold mb-0.5">å¹´æ¯æ•¸ / å¹´èŠ±è²»</div>
                <div class="flex justify-between items-baseline"><span class="text-lg font-bold text-blue-500" id="year-cups">0</span><span class="text-sm font-bold text-gray-600">$<span id="year-cost">0</span></span></div>
            </div>
        </div>

        <div class="flex border-b border-gray-100">
            <button onclick="switchView('calendar')" id="tab-calendar" class="tab-btn active text-2xl">ğŸ¥¤</button>
            <button onclick="switchView('list')" id="tab-list" class="tab-btn">æ¸…å–®</button>
        </div>
    </div>

    <div id="calendar-view-container" class="flex flex-col flex-grow overflow-hidden">
        <div class="flex-none px-4 py-2 flex items-center justify-between">
            <button onclick="changeMonth(-1)" class="w-8 h-8 text-gray-400"><i class="fas fa-chevron-left"></i></button>
            <h2 class="text-md font-bold text-gray-700" id="current-month-display">2026å¹´ 1æœˆ</h2>
            <button onclick="changeMonth(1)" class="w-8 h-8 text-gray-400"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="flex-grow overflow-y-auto px-4 pb-24 no-scrollbar">
            <div class="bg-white rounded-2xl p-3 shadow-sm border mb-4">
                <div class="grid grid-cols-7 gap-1 mb-2 text-center text-[10px] text-gray-300 font-bold uppercase">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div class="calendar-grid" id="calendar-grid"></div>
            </div>
        </div>
    </div>

    <div id="list-view-container" class="hidden flex-col flex-grow overflow-hidden">
        <div class="flex-none px-4 py-3 flex gap-2">
            <div class="bg-gray-200/50 p-1 rounded-xl flex gap-1 text-[10px] flex-grow">
                <button onclick="switchListType('month')" id="subtab-month" class="bg-white text-theme shadow-sm py-2 flex-1 rounded-lg font-bold">ç•¶æœˆæ˜ç´°</button>
                <button onclick="switchListType('year')" id="subtab-year" class="text-gray-400 py-2 flex-1 rounded-lg font-bold">å…¨å¹´åº¦ç´€éŒ„</button>
            </div>
            <button onclick="toggleSort()" class="w-10 h-10 bg-white rounded-xl shadow-sm flex items-center justify-center text-gray-400"><i id="sort-icon" class="fas fa-sort-amount-down"></i></button>
        </div>
        <div class="flex-grow overflow-y-auto px-4 pb-24 no-scrollbar" id="list-items-container"></div>
    </div>

    <button onclick="openQuickAdd()" class="fixed bottom-6 right-6 w-14 h-14 bg-theme text-white rounded-full flex items-center justify-center text-2xl z-40 shadow-lg active:scale-90 transition-transform">
        <i class="fas fa-plus"></i>
    </button>

    <div id="day-detail-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-end sm:items-center justify-center z-50 transition-opacity opacity-0" onclick="if(event.target === this) closeDayDetail()">
        <div class="bg-white w-full sm:w-[450px] sm:rounded-2xl rounded-t-2xl max-h-[80vh] flex flex-col shadow-2xl transform transition-transform translate-y-full" id="day-detail-modal-content">
            <div class="p-4 border-b flex justify-between items-center">
                <span class="font-bold text-lg text-gray-700" id="detail-date-title">2026/01/01</span>
                <button onclick="closeDayDetail()" class="text-gray-400 w-8 h-8"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 overflow-y-auto flex-grow no-scrollbar" id="day-records-list"></div>
            <div class="p-4 border-t bg-gray-50">
                <button onclick="openEntryForm(currentViewingDate)" class="w-full bg-theme text-white font-bold py-3 rounded-xl shadow-md flex items-center justify-center gap-2">æ–°å¢ä¸€æ¯</button>
            </div>
        </div>
    </div>

    <div id="entry-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-end sm:items-center justify-center z-50 transition-opacity opacity-0" onclick="if(event.target === this) closeEntryModal()">
        <div class="bg-white w-full sm:w-[450px] sm:rounded-2xl rounded-t-2xl max-h-[95vh] flex flex-col shadow-2xl transform transition-transform translate-y-full" id="entry-modal-content">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <div class="flex flex-col">
                    <span class="font-bold text-lg text-gray-700" id="form-title">ç·¨è¼¯è³‡æ–™</span>
                    <span class="text-[10px] text-gray-400 font-bold" id="form-date-subtitle">2026/01/01</span>
                </div>
                <button onclick="closeEntryModal()" class="text-gray-400 w-8 h-8"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-5 overflow-y-auto space-y-4 no-scrollbar">
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex flex-col gap-1"><label class="text-[10px] font-bold text-gray-400">åº—å</label><input type="text" id="input-shop" class="bg-gray-50 border-b-2 border-gray-200 p-2 outline-none focus:border-theme"></div>
                    <div class="flex flex-col gap-1"><label class="text-[10px] font-bold text-gray-400">å“é …</label><input type="text" id="input-item" class="bg-gray-50 border-b-2 border-gray-200 p-2 outline-none focus:border-theme"></div>
                </div>
                <div class="w-1/3"><label class="text-[10px] font-bold text-gray-400">åƒ¹æ ¼</label><input type="number" id="input-price" class="w-full bg-gray-50 border-b-2 border-gray-200 p-2 font-bold outline-none focus:border-theme"></div>
                <div>
                    <label class="text-xs font-bold text-gray-400 mb-2 block">å†°å¡Š / ç”œåº¦</label>
                    <div class="flex flex-wrap gap-2 mb-3" id="ice-options"></div>
                    <div class="flex flex-wrap gap-2 mb-4" id="sugar-options"></div>
                    <label class="text-xs font-bold text-gray-400 mb-2 block">æˆ‘çš„å¿ƒæƒ…</label>
                    <textarea id="input-note" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none text-sm" rows="3"></textarea>
                </div>
            </div>
            <div class="p-4 border-t flex gap-3">
                <button onclick="clearForm()" class="px-6 py-3 font-bold text-gray-400">æ¸…ç©º</button>
                <button onclick="saveEntry()" class="flex-1 bg-theme text-white font-bold py-3 rounded-xl shadow-md">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="settings-menu" class="fixed inset-0 bg-black/50 z-50 hidden" onclick="if(event.target === this) toggleSettings()">
        <div class="absolute right-4 top-16 bg-white rounded-2xl shadow-xl w-72 overflow-hidden">
            <div class="p-4 border-b bg-gray-50 text-[10px] font-mono">
                <p class="text-gray-400 mb-1 uppercase tracking-tighter">Sync Code</p>
                <div class="flex gap-2"><input type="text" id="user-uid" readonly class="flex-1 bg-white border p-2 rounded"><button onclick="copyUID()" class="bg-gray-200 px-2 rounded">COPY</button></div>
            </div>
            <div class="p-4 border-b">
                <div class="flex gap-2 mb-3">
                    <button id="target-theme" onclick="setColorTarget('theme')" class="flex-1 py-1 border-2 border-theme rounded text-[10px] font-bold">ä¸»é¡Œè‰²</button>
                    <button id="target-bg" onclick="setColorTarget('bg')" class="flex-1 py-1 border-2 border-transparent rounded text-[10px] font-bold">èƒŒæ™¯è‰²</button>
                </div>
                <div class="flex flex-wrap gap-2" id="color-palette"></div>
            </div>
            <div class="p-4"><input type="text" id="import-uid" class="w-full bg-gray-100 p-2 text-xs rounded mb-2" placeholder="è²¼å…¥åŒæ­¥ä»£ç¢¼"><button onclick="switchUser()" class="w-full bg-theme text-white py-2 rounded text-xs font-bold">é–‹å§‹åŒæ­¥</button></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCLwMbIgQaF_KWYNWruOrHDrMopGJFx470",
            authDomain: "drink-diary-2026.firebaseapp.com",
            projectId: "drink-diary-2026",
            storageBucket: "drink-diary-2026.firebasestorage.app",
            messagingSenderId: "994141313696",
            appId: "1:994141313696:web:d14b3a97541fa6e0e207c5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'drink-diary-2026';

        window.drinkDB = {};
        window.userSettings = { bgColor: '#fdf6e3', themeColor: '#f87171' };
        window.currentUser = null;
        let unsubscribeSync = null;
        let colorTarget = 'theme';

        onAuthStateChanged(auth, (user) => {
            if (user) { window.currentUser = user; document.getElementById('user-uid').value = user.uid; startSync(user.uid); }
            else { signInAnonymously(auth); }
        });

        function startSync(uid) {
            if (unsubscribeSync) unsubscribeSync();
            unsubscribeSync = onSnapshot(doc(db, 'artifacts', appId, 'users', uid), (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    window.drinkDB = data.records || {};
                    window.userSettings = data.settings || window.userSettings;
                }
                window.applyTheme(); renderAll(); hideLoading();
            });
        }

        window.saveData = async () => {
            const uid = document.getElementById('user-uid').value;
            if (!uid) return;
            await setDoc(doc(db, 'artifacts', appId, 'users', uid), { records: window.drinkDB, settings: window.userSettings }, { merge: true });
        };

        const YEAR = 2026;
        const iceOpts = ['å›ºå®š', 'æ­£å¸¸', 'å°‘å†°', 'å¾®å†°', 'å»å†°', 'å¸¸æº«', 'ç†±'];
        const sugarOpts = ['å›ºå®š', 'å…¨ç³–', 'å°‘ç³–', 'åŠç³–', 'å¾®ç³–', 'ä¸€åˆ†ç³–', 'ç„¡ç³–'];
        const colors = ['#f87171','#60a5fa','#34d399','#91a3b0','#b4c4d1','#d8a7b1','#af9483','#a3b18a','#84a59d','#9d8189','#4a4e69','#fdf6e3','#ffffff','#000000'];

        let currentMonth = new Date().getMonth();
        let currentViewingDate = '';
        let listType = 'month';
        let sortOrder = 'desc';
        let selectedIce = '', selectedSugar = '';
        let editingIdx = null;

        window.applyTheme = () => {
            document.documentElement.style.setProperty('--bg-color', window.userSettings.bgColor);
            document.documentElement.style.setProperty('--theme-color', window.userSettings.themeColor);
            document.body.style.backgroundColor = window.userSettings.bgColor;
            document.getElementById('target-theme').style.borderColor = colorTarget === 'theme' ? window.userSettings.themeColor : 'transparent';
            document.getElementById('target-bg').style.borderColor = colorTarget === 'bg' ? window.userSettings.themeColor : 'transparent';
        };

        window.renderAll = () => {
            document.getElementById('current-month-display').innerText = `${YEAR}å¹´ ${currentMonth+1}æœˆ`;
            updateStats(); renderCalendar(); renderList();
            if(!document.getElementById('day-detail-modal').classList.contains('hidden')) renderDayDetail(currentViewingDate);
        };

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid'); grid.innerHTML = '';
            const first = new Date(YEAR, currentMonth, 1).getDay();
            const days = new Date(YEAR, currentMonth + 1, 0).getDate();
            const todayStr = new Date().toISOString().split('T')[0];

            for(let i=0; i<first; i++) grid.appendChild(Object.assign(document.createElement('div'), {className:"day-cell opacity-0"}));
            for(let d=1; d<=days; d++) {
                const ds = `${YEAR}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const records = window.drinkDB[ds] || [];
                const cell = document.createElement('div');
                let level = records.length >= 3 ? 'level-3' : (records.length === 2 ? 'level-2' : (records.length === 1 ? 'level-1' : ''));
                cell.className = `day-cell flex flex-col items-center justify-center cursor-pointer ${ds === todayStr ? 'today' : ''} ${level || 'bg-white/40'}`;
                cell.innerHTML = records.length > 0 ? `<span>ğŸ¥¤</span>` : `<span class="text-sm text-gray-400">${d}</span>`;
                cell.onclick = () => showDayDetail(ds);
                grid.appendChild(cell);
            }
        }

        // æ ¸å¿ƒä¿®æ”¹ï¼šè¬èƒ½æ»‘å‹•å€åŸŸ
        function createSwipeItem(record, date, idx, isFromCalendar) {
            const wrapper = document.createElement('div');
            wrapper.className = 'swipe-item shadow-sm';
            wrapper.innerHTML = `<div class="swipe-actions"><div class="action-btn btn-edit">ä¿®æ”¹</div><div class="action-btn btn-delete">åˆªé™¤</div></div>`;
            
            const content = document.createElement('div');
            content.className = 'swipe-content p-4 border-b flex justify-between items-center';
            const displayDate = date.replace(/-/g, '/');
            
            // å¦‚æœæ˜¯ç•¶æœˆæ˜ç´°ï¼Œé¡¯ç¤ºå¿ƒæƒ…
            const showNote = (listType === 'month' && !isFromCalendar && record.note) ? `<div class="text-[10px] text-theme/70 mt-1 italic font-medium">ã€Œ ${record.note} ã€</div>` : '';
            
            content.innerHTML = `<div><div class="text-[10px] text-gray-400 font-bold mb-0.5">${displayDate}</div><div class="font-bold text-gray-700">${record.shop} Â· ${record.item}</div><div class="text-[10px] text-gray-400">${record.ice} / ${record.sugar}</div>${showNote}</div><div class="text-lg font-bold text-theme">$${record.price}</div>`;
            
            let startX = 0, currentX = 0, isDragging = false;
            content.ontouchstart = (e) => { startX = e.touches[0].pageX; isDragging = true; content.style.transition = 'none'; };
            content.ontouchmove = (e) => {
                if(!isDragging) return;
                currentX = e.touches[0].pageX - startX;
                if(currentX < -150) currentX = -150; if(currentX > 0) currentX = 0;
                content.style.transform = `translateX(${currentX}px)`;
            };
            content.ontouchend = () => {
                isDragging = false; content.style.transition = 'transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1)';
                if(currentX < -70) content.style.transform = 'translateX(-140px)';
                else { 
                    content.style.transform = 'translateX(0px)';
                    // åªæœ‰åœ¨æ—¥æ›†æ¨¡å¼ä¸‹çš„å½ˆçª—é»æ“Šæ‰å¯ä»¥ç›´æ¥ç·¨è¼¯
                    if(currentX === 0 && isFromCalendar) openEntryForm(date, idx);
                }
            };
            
            wrapper.querySelector('.btn-edit').onclick = () => { content.style.transform = 'translateX(0px)'; openEntryForm(date, idx); };
            wrapper.querySelector('.btn-delete').onclick = () => { window.drinkDB[date].splice(idx, 1); if(window.drinkDB[date].length === 0) delete window.drinkDB[date]; window.saveData(); renderAll(); };
            
            wrapper.appendChild(content); return wrapper;
        }

        function renderList() {
            const container = document.getElementById('list-items-container'); container.innerHTML = '';
            let all = [];
            const mPrefix = `${YEAR}-${String(currentMonth+1).padStart(2,'0')}`;
            Object.keys(window.drinkDB).forEach(d => {
                if (listType === 'month' && !d.startsWith(mPrefix)) return;
                window.drinkDB[d].forEach((r, idx) => all.push({...r, date: d, idx}));
            });
            all.sort((a, b) => sortOrder === 'desc' ? b.date.localeCompare(a.date) : a.date.localeCompare(b.date));
            all.forEach(r => container.appendChild(createSwipeItem(r, r.date, r.idx, false)));
        }

        window.showDayDetail = (ds) => {
            currentViewingDate = ds;
            document.getElementById('detail-date-title').innerText = ds.replace(/-/g, '/');
            renderDayDetail(ds); toggleModal('day-detail-modal', true);
        };

        function renderDayDetail(ds) {
            const list = document.getElementById('day-records-list'); list.innerHTML = '';
            const records = window.drinkDB[ds] || [];
            if(records.length === 0) list.innerHTML = `<p class="text-center text-gray-300 py-10 text-sm">é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢ç´€éŒ„</p>`;
            records.forEach((r, idx) => list.appendChild(createSwipeItem(r, ds, idx, true)));
        }

        window.openEntryForm = (ds, idx = null) => {
            currentViewingDate = ds; editingIdx = idx;
            document.getElementById('form-date-subtitle').innerText = ds.replace(/-/g, '/');
            document.getElementById('form-title').innerText = idx !== null ? 'ç·¨è¼¯ç´€éŒ„' : 'æ–°å¢ç´€éŒ„';
            if(idx !== null) {
                const r = window.drinkDB[ds][idx];
                document.getElementById('input-shop').value = r.shop; document.getElementById('input-item').value = r.item;
                document.getElementById('input-price').value = r.price; document.getElementById('input-note').value = r.note || '';
                selectedIce = r.ice; selectedSugar = r.sugar;
                updateChips('ice-options', r.ice); updateChips('sugar-options', r.sugar);
            } else clearForm();
            toggleModal('entry-modal', true);
        };

        window.saveEntry = () => {
            const shop = document.getElementById('input-shop').value; const item = document.getElementById('input-item').value;
            const price = document.getElementById('input-price').value; if(!shop || !item) return alert('è«‹å®Œæ•´å¡«å¯«');
            if(!window.drinkDB[currentViewingDate]) window.drinkDB[currentViewingDate] = [];
            const data = { shop, item, price, ice: selectedIce, sugar: selectedSugar, note: document.getElementById('input-note').value };
            if(editingIdx !== null) window.drinkDB[currentViewingDate][editingIdx] = data;
            else window.drinkDB[currentViewingDate].push(data);
            window.saveData(); closeEntryModal();
        };

        window.setColorTarget = (t) => { colorTarget = t; window.applyTheme(); };
        const palette = document.getElementById('color-palette');
        colors.forEach(c => {
            const d = document.createElement('div'); d.className = 'swatch'; d.style.backgroundColor = c;
            d.onclick = () => {
                if(colorTarget === 'theme') window.userSettings.themeColor = c; else window.userSettings.bgColor = c;
                window.applyTheme(); window.saveData();
            };
            palette.appendChild(d);
        });

        window.hideLoading = () => { document.getElementById('loading-screen').style.display='none'; };
        window.toggleSettings = () => document.getElementById('settings-menu').classList.toggle('hidden');
        window.copyUID = () => { navigator.clipboard.writeText(document.getElementById('user-uid').value); alert('ä»£ç¢¼å·²è¤‡è£½'); };
        window.changeMonth = (d) => { currentMonth = (currentMonth+d+12)%12; renderAll(); };
        window.openQuickAdd = () => openEntryForm(new Date().toISOString().split('T')[0]);
        window.closeEntryModal = () => toggleModal('entry-modal', false);
        window.closeDayDetail = () => toggleModal('day-detail-modal', false);
        window.toggleSort = () => { sortOrder = sortOrder === 'desc' ? 'asc' : 'desc'; document.getElementById('sort-icon').className = sortOrder === 'desc' ? 'fas fa-sort-amount-down' : 'fas fa-sort-amount-up'; renderList(); };
        window.clearForm = () => { document.getElementById('input-shop').value = ''; document.getElementById('input-item').value = ''; document.getElementById('input-price').value = ''; document.getElementById('input-note').value = ''; selectedIce = ''; selectedSugar = ''; Array.from(document.querySelectorAll('.chip-btn')).forEach(c => c.classList.remove('selected')); };
        function updateChips(id, val) { Array.from(document.getElementById(id).children).forEach(c => c.classList.toggle('selected', c.innerText === val)); }
        window.switchView = (v) => {
            document.getElementById('calendar-view-container').classList.toggle('hidden', v==='list');
            document.getElementById('list-view-container').classList.toggle('hidden', v==='calendar');
            document.getElementById('tab-calendar').classList.toggle('active', v==='calendar');
            document.getElementById('tab-list').classList.toggle('active', v==='list');
        };
        window.switchListType = (type) => {
            listType = type;
            document.getElementById('subtab-month').className = type === 'month' ? 'bg-white text-theme shadow-sm py-2 flex-1 rounded-lg font-bold' : 'text-gray-400 py-2 flex-1 rounded-lg font-bold';
            document.getElementById('subtab-year').className = type === 'year' ? 'bg-white text-theme shadow-sm py-2 flex-1 rounded-lg font-bold' : 'text-gray-400 py-2 flex-1 rounded-lg font-bold';
            renderList();
        };
        function updateStats() {
            let mc=0, m$=0, yc=0, y$=0; const mPrefix = `${YEAR}-${String(currentMonth+1).padStart(2,'0')}`;
            Object.keys(window.drinkDB).forEach(d => {
                window.drinkDB[d].forEach(r => {
                    const p = parseInt(r.price)||0; yc++; y$+=p;
                    if(d.startsWith(mPrefix)) { mc++; m$+=p; }
                });
            });
            document.getElementById('month-cups').innerText = mc; document.getElementById('month-cost').innerText = m$;
            document.getElementById('year-cups').innerText = yc; document.getElementById('year-cost').innerText = y$;
        }
        function toggleModal(id, show) {
            const m = document.getElementById(id), c = document.getElementById(id + '-content');
            if(show) { m.classList.remove('hidden'); setTimeout(()=> { m.classList.remove('opacity-0'); c.classList.remove('translate-y-full'); }, 10); }
            else { m.classList.add('opacity-0'); c.classList.add('translate-y-full'); setTimeout(()=> m.classList.add('hidden'), 300); }
        }
        const mkChip = (t, type) => {
            const b = document.createElement('button'); b.className = 'chip-btn'; b.innerText = t;
            b.onclick = (e) => { Array.from(e.target.parentElement.children).forEach(c=>c.classList.remove('selected')); e.target.classList.add('selected'); if(type==='ice') selectedIce=t; else selectedSugar=t; };
            return b;
        };
        iceOpts.forEach(o => document.getElementById('ice-options').appendChild(mkChip(o, 'ice')));
        sugarOpts.forEach(o => document.getElementById('sugar-options').appendChild(mkChip(o, 'sugar')));
    </script>
</body>
</html>
