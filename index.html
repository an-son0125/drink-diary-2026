<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2026 翊維飲料日記</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        :root { --bg-color: #f4f1ea; --theme-color: #95a78d; --text-color: #5b5b5b; }
        
        * { touch-action: manipulation; }
        
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-color); color: var(--text-color); transition: all 0.3s ease; font-size: 14px; -webkit-text-size-adjust: 100%; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .modal-content-rounded { 
            border-radius: 28px !important; 
            overflow: hidden !important;
            margin-bottom: 20px;
        }
        @media (max-width: 640px) {
            .modal-content-rounded { 
                margin-bottom: 10px;
                width: calc(100% - 20px) !important;
            }
        }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .stat-card { background: white; padding: 12px; border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .stat-label { font-size: 13px; font-weight: 900; color: #a1a1a1; margin-bottom: 4px; }
        .stat-value { font-size: 1.6rem; font-weight: 900; color: var(--theme-color); line-height: 1.1; }
        .stat-unit { font-size: 12px; font-weight: 700; color: #d1d1d1; margin-left: 2px; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day-cell { aspect-ratio: 1/1; border-radius: 14px; font-size: 14px; font-weight: 700; display: flex; align-items: center; justify-content: center; background: white; border: 1px solid rgba(0,0,0,0.02); position: relative; cursor: pointer; }
        .day-cell.today { border: 2px solid var(--theme-color); color: var(--theme-color); }
        .badge { position: absolute; top: -2px; right: -2px; background: white; color: var(--theme-color); font-size: 9px; min-width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; border: 1px solid var(--theme-color); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        .swipe-item { position: relative; overflow: hidden; border-radius: 16px; margin-bottom: 6px; background: #f0f0f0; user-select: none; }
        .btn-action { position: absolute; top: 0; bottom: 0; width: 64px; display: flex; align-items: center; justify-content: center; font-weight: 900; color: white; z-index: 1; cursor: pointer; }
        .btn-del { right: 0; background-color: #e5989b; }
        .btn-edit { left: 0; background-color: #b8c0ff; }
        .swipe-content { position: relative; z-index: 10; background: white; transition: transform 0.2s ease-out; cursor: grab; }
        
        .tab-btn { padding: 8px 0; font-weight: 900; font-size: 16px; color: #ccc; flex: 1; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: var(--text-color); border-bottom-color: var(--theme-color); }

        .chip-btn { border: 1px solid #eee; color: #888; padding: 6px 14px; border-radius: 50px; font-size: 13px; font-weight: 700; background: white; }
        .chip-btn.selected { background-color: var(--theme-color) !important; color: white !important; border-color: var(--theme-color) !important; }

        #settings-menu { 
            position: absolute; 
            top: 60px; 
            right: 20px; 
            background: white; 
            border-radius: 20px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.2); 
            width: 220px; 
            z-index: 500; 
            overflow-y: auto; 
            max-height: 70vh; 
            border: 1px solid #eee; 
        }
        .setting-opt { padding: 12px; font-weight: 700; font-size: 14px; border-bottom: 1px solid #f9f9f9; width: 100%; text-align: left; display: flex; align-items: center; gap: 8px; }
        .uid-box { padding: 10px; background: #f8f8f8; font-size: 10px; word-break: break-all; color: #999; font-family: monospace; border-bottom: 1px solid #eee; }
        
        #copy-toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 8px 20px; border-radius: 50px; font-size: 12px; font-weight: bold; z-index: 600; display: none; }
        
        .repurchase-btn { flex: 1; border: 1px solid #eee; border-radius: 12px; padding: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: all 0.2s; background: white; color: #ddd; }
        .repurchase-btn.active-yes { background-color: #ffdde1; color: #ff5c5c; border-color: #ffdde1; }
        .repurchase-btn.active-no { background-color: #f0f0f0; color: #999; border-color: #ccc; }

        .feature-btn {
            background: white; border: 1px solid #f0f0f0; color: #aaa; font-weight: 900; font-size: 12px;
            padding: 8px; border-radius: 12px; flex: 1; transition: all 0.2s;
        }
        .feature-btn.active {
            background: var(--theme-color); color: white; border-color: var(--theme-color); box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .repurchase-filter-btn {
            padding: 8px 12px; border-radius: 12px; font-weight: 900; font-size: 12px; flex: 1; text-align: center; border: 1px solid #eee; background: white; color: #ccc;
        }
        .repurchase-filter-btn.active {
            background: #fff; border-color: var(--theme-color); color: var(--theme-color); box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden">

    <div id="loading-screen" class="fixed inset-0 bg-white z-[300] flex flex-col items-center justify-center font-black text-gray-300">
        <div class="w-10 h-10 border-4 border-gray-100 border-t-gray-400 rounded-full animate-spin mb-4"></div>
        LOADING...
    </div>

    <div id="copy-toast">已複製 UID</div>

    <div class="flex-none p-4 pb-0 z-50 relative">
        <div class="flex justify-between items-start mb-3">
            <div>
                <h1 class="text-xl font-black flex items-center gap-2">
                    <span id="theme-icon-box" class="w-9 h-9 rounded-2xl flex items-center justify-center shadow-sm" style="background-color: var(--theme-color); color: white;"><i class="fas fa-heart text-sm"></i></span>
                    <span>翊維飲料日記</span>
                </h1>
                <p class="text-[10px] font-black tracking-[0.2em] opacity-50 mt-0.5 ml-1">DRINK DIARY 2026</p>
            </div>
            <button onclick="toggleSettings(event)" class="w-9 h-9 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-400 border border-gray-100 relative z-[501]">
                <i class="fas fa-sliders-h text-lg"></i>
            </button>
        </div>

        <div id="settings-menu" class="hidden no-scrollbar">
            <div class="uid-box"><div class="font-black mb-1 text-gray-500">當前 UID:</div><span id="display-uid">...</span></div>
            <button onclick="copyUID()" class="setting-opt text-gray-600"><i class="fas fa-copy w-4"></i> 複製 UID</button>
            <button onclick="showLoginModal()" class="setting-opt text-blue-500"><i class="fas fa-sign-in-alt w-4"></i> 輸入 UID 登入</button>
            <button onclick="resetAccount()" class="setting-opt text-red-400"><i class="fas fa-power-off w-4"></i> 重設並登出</button>
            <div class="h-[1px] bg-gray-100"></div>
            <button onclick="changeTheme('#f4f1ea', '#95a78d', '#5b5b5b')" class="setting-opt text-[#95a78d]">鼠尾草綠</button>
            <button onclick="changeTheme('#f8f4f9', '#b8c0ff', '#5e6472')" class="setting-opt text-[#b8c0ff]">薰衣草紫</button>
            <button onclick="changeTheme('#fff5f5', '#ffafbd', '#4a4a4a')" class="setting-opt text-[#ffafbd]">櫻花粉</button>
            <button onclick="changeTheme('#fffaf0', '#fbc4ab', '#6d597a')" class="setting-opt text-[#fbc4ab]">蜜桃奶茶</button>
        </div>

        <div id="global-stats-container" class="stat-grid">
            <div class="stat-card"><div class="stat-label">本月累積</div><div class="flex items-baseline"><span class="stat-value" id="month-cups">0</span><span class="stat-unit">杯</span></div></div>
            <div class="stat-card"><div class="stat-label">本月花費</div><div class="flex items-baseline"><span class="stat-value" id="month-cost">0</span><span class="stat-unit">元</span></div></div>
            <div class="stat-card"><div class="stat-label">年度累積</div><div class="flex items-baseline"><span class="stat-value" id="year-cups">0</span><span class="stat-unit">杯</span></div></div>
            <div class="stat-card"><div class="stat-label">年度花費</div><div class="flex items-baseline"><span class="stat-value" id="year-cost">0</span><span class="stat-unit">元</span></div></div>
        </div>

        <div class="flex">
            <button onclick="switchView('calendar')" id="tab-calendar" class="tab-btn active">日曆</button>
            <button onclick="switchView('list')" id="tab-list" class="tab-btn">清單</button>
        </div>
    </div>

    <div id="calendar-view-container" class="flex flex-col flex-grow overflow-hidden">
        <div class="flex-none px-6 py-2 flex items-center justify-between">
            <button onclick="changeMonth(-1)" class="opacity-30 p-2"><i class="fas fa-chevron-left text-xl"></i></button>
            <h2 class="font-black text-lg text-gray-500" id="current-month-display">2026年 1月</h2>
            <button onclick="changeMonth(1)" class="opacity-30 p-2"><i class="fas fa-chevron-right text-xl"></i></button>
        </div>
        <div class="flex-grow overflow-y-auto px-4 pb-24 no-scrollbar">
            <div class="bg-white rounded-3xl p-4 shadow-sm border border-gray-100">
                <div class="grid grid-cols-7 gap-1 mb-3 text-center text-[10px] opacity-40 font-black">
                    <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
                </div>
                <div class="calendar-grid" id="calendar-grid"></div>
            </div>
        </div>
    </div>

    <div id="list-view-container" class="hidden flex flex-col flex-grow overflow-hidden">
        <div class="flex-none px-4 py-2 flex flex-col gap-2">
            <div class="flex justify-between items-center w-full">
                <div class="bg-white/60 p-1 rounded-full flex gap-1 border border-white flex-grow mr-2">
                    <button onclick="switchListType('month')" id="subtab-month" class="bg-white py-1.5 flex-1 rounded-full font-black shadow-sm text-xs">當月</button>
                    <button onclick="switchListType('year')" id="subtab-year" class="text-gray-300 py-1.5 flex-1 rounded-full font-black text-xs">年度</button>
                </div>
                <button onclick="toggleSort()" class="w-8 h-8 bg-white rounded-full shadow-sm text-gray-400 flex items-center justify-center border border-gray-100"><i id="sort-icon" class="fas fa-sort-amount-down"></i></button>
            </div>
            <div class="flex gap-2 w-full">
                <button onclick="switchListType('stats')" id="subtab-stats" class="feature-btn">每月統計</button>
                <button onclick="switchListType('repurchase')" id="subtab-repurchase" class="feature-btn">回購明細</button>
            </div>
            <div id="repurchase-filters" class="hidden flex gap-2 w-full mt-1">
                <button onclick="setRepurchaseFilter(true)" id="filter-repurchase-yes" class="repurchase-filter-btn">值得回購 <i class="fas fa-heart"></i></button>
                <button onclick="setRepurchaseFilter(false)" id="filter-repurchase-no" class="repurchase-filter-btn">不再回購 <i class="fas fa-heart-broken"></i></button>
            </div>
        </div>
        <div class="flex-grow overflow-y-auto px-4 pb-24 no-scrollbar" id="list-items-container"></div>
    </div>

    <div id="login-modal" class="fixed inset-0 bg-black/50 backdrop-blur-md hidden items-center justify-center z-[250] p-6" onclick="if(event.target === this) closeLoginModal()">
        <div class="bg-white w-full max-w-[320px] rounded-3xl p-6 shadow-2xl">
            <h3 class="font-black text-xl mb-2">切換帳號</h3>
            <input type="text" id="input-uid" class="w-full bg-gray-100 rounded-xl p-4 text-xs font-mono mb-4 outline-none" placeholder="貼上 UID...">
            <div class="flex gap-2"><button onclick="closeLoginModal()" class="flex-1 py-3 text-gray-400 font-black">取消</button><button onclick="loginWithUID()" class="flex-1 py-3 bg-blue-500 text-white rounded-xl font-black">登入</button></div>
        </div>
    </div>

    <div id="day-detail-modal" class="fixed inset-0 bg-black/30 backdrop-blur-sm hidden items-end sm:items-center justify-center z-[150] transition-opacity opacity-0" onclick="if(event.target === this) closeDayDetail()">
        <div class="bg-white w-full sm:w-[380px] modal-content-rounded max-h-[75vh] flex flex-col shadow-2xl transform translate-y-full transition-transform" id="day-detail-modal-content">
            <div class="p-5 border-b border-gray-50 flex justify-between items-center">
                <span class="font-black text-xl text-gray-600" id="detail-date-title"></span>
                <div class="flex gap-4 items-center">
                    <button onclick="batchAddFromDetail()" class="text-theme text-xl"><i class="fas fa-plus-circle"></i></button>
                    <button onclick="closeDayDetail()"><i class="fas fa-times text-2xl opacity-20"></i></button>
                </div>
            </div>
            <div class="p-5 overflow-y-auto flex-grow no-scrollbar" id="day-records-list"></div>
        </div>
    </div>

    <div id="entry-modal" class="fixed inset-0 bg-black/40 backdrop-blur-md hidden items-end sm:items-center justify-center z-[150] transition-opacity opacity-0" onclick="if(event.target === this) closeEntryModal()">
        <div class="bg-white w-full sm:w-[380px] modal-content-rounded h-[85vh] flex flex-col shadow-2xl transform translate-y-full transition-transform" id="entry-modal-content">
            <div class="flex-none p-6 pb-2">
                <div class="flex justify-between items-center mb-3"><span class="font-black text-xl" id="form-title">新增紀錄</span><button onclick="closeEntryModal()" class="opacity-20"><i class="fas fa-times text-xl"></i></button></div>
                <input type="text" id="input-date-text" class="w-full bg-gray-50 border-b-2 p-3 font-black text-lg outline-none rounded-xl" style="border-color: var(--theme-color)">
            </div>
            <div class="p-6 pt-2 space-y-4 overflow-y-auto no-scrollbar flex-grow">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-xs font-black text-gray-400 mb-1 block">店名</label><input type="text" id="input-shop" class="w-full bg-gray-50 rounded-xl p-3 outline-none font-black border-none" placeholder="50嵐"></div>
                    <div><label class="text-xs font-black text-gray-400 mb-1 block">品項</label><input type="text" id="input-item" class="w-full bg-gray-50 rounded-xl p-3 outline-none font-black border-none" placeholder="珍珠奶茶"></div>
                </div>
                <div><label class="text-xs font-black text-gray-400 mb-1 block">價格</label><input type="number" id="input-price" class="w-full bg-gray-50 rounded-xl p-3 font-black text-xl outline-none border-none" placeholder="$"></div>
                <div><label class="text-xs font-black text-gray-400 mb-2 block">冰塊</label><div class="flex flex-wrap gap-1" id="ice-options"></div></div>
                <div><label class="text-xs font-black text-gray-400 mb-2 block">甜度</label><div class="flex flex-wrap gap-1" id="sugar-options"></div></div>
                <div>
                    <label class="text-xs font-black text-gray-400 mb-2 block">回購</label>
                    <div class="flex gap-2">
                        <button id="btn-repurchase-yes" onclick="setRepurchase(true)" class="repurchase-btn"><i class="fas fa-heart"></i></button>
                        <button id="btn-repurchase-no" onclick="setRepurchase(false)" class="repurchase-btn"><i class="fas fa-heart-broken"></i></button>
                    </div>
                </div>
                <div><label class="text-xs font-black text-gray-400 mb-1 block">我的心情</label><textarea id="input-note" class="w-full bg-gray-50 rounded-xl p-3 text-sm font-bold outline-none border-none" rows="2"></textarea></div>
            </div>
            <div class="p-6 flex gap-3"><button onclick="clearForm()" class="px-4 font-black text-gray-400 text-sm">清空</button><button onclick="saveEntry()" class="flex-1 text-white font-black py-4 rounded-xl shadow-lg text-lg" style="background-color: var(--theme-color)">儲存紀錄</button></div>
        </div>
    </div>

    <button onclick="openQuickAdd()" class="fixed bottom-6 right-6 w-14 h-14 text-white rounded-full flex items-center justify-center text-2xl z-40 shadow-xl active:scale-90 transition-transform" style="background-color: var(--theme-color)"><i class="fas fa-plus"></i></button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyCLwMbIgQaF_KWYNWruOrHDrMopGJFx470", appId: "1:994141313696:web:d14b3a97541fa6e0e207c5",
            authDomain: "drink-diary-2026.firebaseapp.com", projectId: "drink-diary-2026"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.drinkDB = {};
        window.userSettings = { bgColor: '#f4f1ea', themeColor: '#95a78d', textColor: '#5b5b5b' };
        let unsubscribeSync = null, currentMonth = new Date().getMonth(), currentViewingDate = '', listType = 'month', editingIdx = null, selectedIce = '', selectedSugar = '', sortOrder = 'desc', activeUID = null;
        let selectedRepurchase = null; 
        let repurchaseFilterVal = true; 
        const YEAR = 2026;

        onAuthStateChanged(auth, (user) => { 
            if (user) { 
                activeUID = localStorage.getItem('custom_uid') || user.uid;
                document.getElementById('display-uid').innerText = activeUID;
                startSync(activeUID); 
            } else { signInAnonymously(auth); } 
        });

        function startSync(uid) {
            if (unsubscribeSync) unsubscribeSync();
            unsubscribeSync = onSnapshot(doc(db, 'artifacts', 'drink-diary-2026', 'users', uid), (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    window.drinkDB = data.records || {};
                    window.userSettings = {...window.userSettings, ...data.settings};
                } else { window.drinkDB = {}; }
                applyTheme(); renderAll(); hideLoading();
            });
        }

        window.saveData = async () => {
            if (!activeUID) return;
            await setDoc(doc(db, 'artifacts', 'drink-diary-2026', 'users', activeUID), { records: window.drinkDB, settings: window.userSettings }, { merge: true });
        };

        window.renderAll = () => {
            document.getElementById('current-month-display').innerText = `${YEAR}年 ${currentMonth+1}月`;
            updateStats(); renderCalendar(); renderList();
            if(!document.getElementById('day-detail-modal').classList.contains('hidden')) renderDayDetail(currentViewingDate);
        };

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid'); if(!grid) return; grid.innerHTML = '';
            const first = new Date(YEAR, currentMonth, 1).getDay();
            const days = new Date(YEAR, currentMonth + 1, 0).getDate();
            const todayStr = new Date().toISOString().split('T')[0];
            for(let i=0; i<first; i++) grid.appendChild(Object.assign(document.createElement('div'), {className:"day-cell opacity-0"}));
            for(let d=1; d<=days; d++) {
                const ds = `${YEAR}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const records = window.drinkDB[ds] || [];
                const cell = document.createElement('div');
                cell.className = `day-cell ${ds === todayStr ? 'today' : ''}`;
                if(records.length > 0) {
                    const isDeep = records.length >= 3;
                    cell.style.background = isDeep ? window.userSettings.themeColor : `${window.userSettings.themeColor}30`;
                    cell.style.color = isDeep ? 'white' : 'inherit';
                }
                cell.innerHTML = `<span>${d}</span>`;
                if(records.length > 1) cell.innerHTML += `<div class="badge">${records.length}</div>`;
                cell.onclick = () => { if(records.length > 0) showDayDetail(ds); else openEntryForm(ds); };
                grid.appendChild(cell);
            }
        }

        window.resetAccount = async () => {
            if(confirm('確定要登出並重設為新帳號嗎？')){
                localStorage.removeItem('custom_uid'); await signOut(auth); location.reload();
            }
        };

        window.copyUID = () => {
            navigator.clipboard.writeText(activeUID).then(() => {
                const t = document.getElementById('copy-toast');
                t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 2000);
            });
        };

        window.showLoginModal = () => { document.getElementById('login-modal').classList.remove('hidden'); document.getElementById('settings-menu').classList.add('hidden'); };
        window.closeLoginModal = () => document.getElementById('login-modal').classList.add('hidden');
        window.loginWithUID = () => {
            const val = document.getElementById('input-uid').value.trim();
            if(val) { localStorage.setItem('custom_uid', val); location.reload(); }
        };

        window.applyTheme = () => {
            document.documentElement.style.setProperty('--bg-color', window.userSettings.bgColor);
            document.documentElement.style.setProperty('--theme-color', window.userSettings.themeColor);
            document.documentElement.style.setProperty('--text-color', window.userSettings.textColor);
            document.body.style.backgroundColor = window.userSettings.bgColor;
            document.getElementById('theme-icon-box').style.backgroundColor = window.userSettings.themeColor;
        };

        window.showDayDetail = (ds) => { 
            currentViewingDate = ds; 
            document.getElementById('detail-date-title').innerText = ds.replace(/-/g, '/'); 
            renderDayDetail(ds); toggleModal('day-detail-modal', true); 
        };
        window.renderDayDetail = (ds) => { 
            const list = document.getElementById('day-records-list'); list.innerHTML = ''; 
            (window.drinkDB[ds] || []).forEach((r, i) => list.appendChild(createSwipeItem(r, ds, i, false))); 
        };

        window.batchAddFromDetail = () => { openEntryForm(currentViewingDate); };

        window.setRepurchase = (val) => {
            selectedRepurchase = val;
            const btnYes = document.getElementById('btn-repurchase-yes');
            const btnNo = document.getElementById('btn-repurchase-no');
            btnYes.classList.toggle('active-yes', val === true);
            btnNo.classList.toggle('active-no', val === false);
        };

        window.setRepurchaseFilter = (val) => {
            repurchaseFilterVal = val;
            document.getElementById('filter-repurchase-yes').classList.toggle('active', val === true);
            document.getElementById('filter-repurchase-no').classList.toggle('active', val === false);
            renderList();
        };

        window.openEntryForm = (ds, idx = null, event = null) => {
            if (event) event.stopPropagation();
            let dStr = ds ? ds.replace(/-/g, '/') : new Date().toLocaleDateString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit'});
            editingIdx = idx;
            document.getElementById('input-date-text').value = dStr;
            clearForm(); 
            if(idx !== null && window.drinkDB[ds]) {
                const r = window.drinkDB[ds][idx];
                document.getElementById('input-shop').value = r.shop; document.getElementById('input-item').value = r.item; document.getElementById('input-price').value = r.price; document.getElementById('input-note').value = r.note || '';
                selectedIce = r.ice; selectedSugar = r.sugar; updateChips('ice-options', selectedIce); updateChips('sugar-options', selectedSugar);
                window.setRepurchase(r.repurchase === undefined ? null : r.repurchase);
            }
            toggleModal('entry-modal', true);
        };

        window.saveEntry = () => {
            const shop = document.getElementById('input-shop').value, item = document.getElementById('input-item').value, price = document.getElementById('input-price').value;
            let chosenDate = document.getElementById('input-date-text').value.replace(/\//g, '-');
            if(!shop || !item || !price || !selectedIce || !selectedSugar) return alert('資訊不完整');
            if(!window.drinkDB[chosenDate]) window.drinkDB[chosenDate] = [];
            const data = { 
                shop, item, price, ice: selectedIce, sugar: selectedSugar, 
                note: document.getElementById('input-note').value,
                repurchase: selectedRepurchase
            };
            if(editingIdx !== null) window.drinkDB[chosenDate][editingIdx] = data; else window.drinkDB[chosenDate].push(data);
            window.saveData(); closeEntryModal(); 
            if(!document.getElementById('day-detail-modal').classList.contains('hidden')) renderDayDetail(chosenDate);
        };

        function createSwipeItem(record, date, idx, isReadOnly) {
            const wrapper = document.createElement('div'); wrapper.className = 'swipe-item';
            let actions = isReadOnly ? '' : `<div class="btn-action btn-del" onclick="delRec('${date}',${idx})"><span>刪除</span></div><div class="btn-action btn-edit" onclick="openEntryForm('${date}',${idx}, event)"><span>更新</span></div>`;
            const noteText = record.note ? ` · ${record.note}` : '';
            
            let repIcon = '';
            if (record.repurchase === true) repIcon = `<i class="fas fa-heart text-red-400 ml-2"></i>`;
            else if (record.repurchase === false) repIcon = `<i class="fas fa-heart-broken text-gray-300 ml-2"></i>`;

            wrapper.innerHTML = `${actions}<div class="swipe-content p-4 flex justify-between items-center"><div><div class="text-[9px] font-black opacity-30">${date.replace(/-/g, '/')}</div><div class="font-black text-base flex items-center">${record.shop} · ${record.item} ${repIcon}</div><div class="text-xs opacity-50 font-bold" style="font-style: normal;">${record.ice}/${record.sugar}${noteText}</div></div><div class="text-xl font-black" style="color:var(--theme-color)">$${record.price}</div></div>`;
            
            const content = wrapper.querySelector('.swipe-content');
            if (isReadOnly) return wrapper;

            let startX = 0, currentX = 0, isDragging = false;
            const onStart = (e) => { startX = (e.touches ? e.touches[0].pageX : e.pageX); content.style.transition = 'none'; isDragging = true; };
            const onMove = (e) => { 
                if (!isDragging) return;
                currentX = (e.touches ? e.touches[0].pageX : e.pageX) - startX; 
                if(currentX < -64) currentX = -64; if(currentX > 64) currentX = 64; 
                content.style.transform = `translateX(${currentX}px)`; 
            };
            const onEnd = () => { 
                if (!isDragging) return;
                isDragging = false;
                content.style.transition = '0.2s'; 
                if(currentX < -32) content.style.transform = 'translateX(-64px)'; 
                else if(currentX > 32) content.style.transform = 'translateX(64px)'; 
                else content.style.transform = 'translateX(0px)'; 
                currentX = 0; 
            };

            content.addEventListener('touchstart', onStart);
            content.addEventListener('touchmove', onMove);
            content.addEventListener('touchend', onEnd);
            content.addEventListener('mousedown', onStart);
            window.addEventListener('mousemove', (e) => onMove(e));
            window.addEventListener('mouseup', () => onEnd());
            return wrapper;
        }

        window.delRec = (d, i) => { 
            window.drinkDB[d].splice(i, 1); 
            if(!window.drinkDB[d].length) delete window.drinkDB[d]; 
            window.saveData(); 
        };

        window.toggleSort = () => { sortOrder = sortOrder === 'desc' ? 'asc' : 'desc'; document.getElementById('sort-icon').className = sortOrder === 'desc' ? 'fas fa-sort-amount-down' : 'fas fa-sort-amount-up'; renderList(); };
        
        window.renderList = () => {
            const container = document.getElementById('list-items-container'); if(!container) return; container.innerHTML = '';
            
            if(listType === 'stats') {
                const statsMap = {};
                for(let m=1; m<=12; m++) statsMap[m] = { count: 0, cost: 0 };
                Object.keys(window.drinkDB).forEach(d => {
                    const m = parseInt(d.split('-')[1]);
                    window.drinkDB[d].forEach(r => { statsMap[m].count++; statsMap[m].cost += (parseInt(r.price) || 0); });
                });
                const grid = document.createElement('div'); grid.className = "flex flex-col gap-2";
                for(let m=1; m<=12; m++) {
                    if(statsMap[m].count === 0) continue;
                    const item = document.createElement('div');
                    item.className = "bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center cursor-pointer active:scale-95 transition-transform";
                    item.innerHTML = `<div><div class="font-black text-lg text-gray-400">${m}月</div></div><div class="text-right"><div class="font-black text-xl" style="color:var(--theme-color)">$${statsMap[m].cost}</div><div class="text-xs font-bold text-gray-300">${statsMap[m].count} 杯</div></div>`;
                    item.onclick = () => { currentMonth = m - 1; switchListType('month'); renderAll(); };
                    grid.appendChild(item);
                }
                if(grid.innerHTML === '') container.innerHTML = '<div class="text-center mt-10 text-gray-300 font-bold">尚無資料</div>';
                else container.appendChild(grid);
                return;
            }

            let all = []; const mPrefix = `${YEAR}-${String(currentMonth+1).padStart(2,'0')}`;
            
            if (listType === 'repurchase') {
                Object.keys(window.drinkDB).forEach(d => {
                    window.drinkDB[d].forEach((r, i) => {
                        if (r.repurchase === repurchaseFilterVal) all.push({...r, date:d, idx:i});
                    });
                });
            } else {
                Object.keys(window.drinkDB).forEach(d => { 
                    if (listType === 'month' && !d.startsWith(mPrefix)) return; 
                    window.drinkDB[d].forEach((r, i) => { all.push({...r, date: d, idx: i}); }); 
                });
            }
            
            all.sort((a,b) => sortOrder === 'desc' ? b.date.localeCompare(a.date) : a.date.localeCompare(b.date));
            if(listType === 'repurchase' && all.length === 0) {
                 container.innerHTML = '<div class="text-center mt-10 text-gray-300 font-bold">尚無相關回購資料</div>';
                 return;
            }

            const isReadOnly = (listType === 'year' || listType === 'repurchase');
            all.forEach(r => container.appendChild(createSwipeItem(r, r.date, r.idx, isReadOnly)));
        };

        window.updateStats = () => {
            let mc=0, m$=0, yc=0, y$=0; const mPrefix = `${YEAR}-${String(currentMonth+1).padStart(2,'0')}`;
            Object.keys(window.drinkDB).forEach(d => { window.drinkDB[d].forEach(r => { const p = parseInt(r.price)||0; yc++; y$+=p; if(d.startsWith(mPrefix)) { mc++; m$+=p; } }); });
            document.getElementById('month-cups').innerText = mc; document.getElementById('month-cost').innerText = m$; document.getElementById('year-cups').innerText = yc; document.getElementById('year-cost').innerText = y$;
        };
        window.toggleSettings = (e) => { e.stopPropagation(); document.getElementById('settings-menu').classList.toggle('hidden'); };
        window.changeTheme = (bg, theme, text) => { window.userSettings = { bgColor: bg, themeColor: theme, textColor: text }; window.saveData(); applyTheme(); };
        window.hideLoading = () => document.getElementById('loading-screen').classList.add('hidden');
        window.changeMonth = (d) => { currentMonth = (currentMonth+d+12)%12; renderAll(); };
        window.openQuickAdd = () => openEntryForm(null);
        window.closeEntryModal = () => { editingIdx = null; toggleModal('entry-modal', false); };
        window.closeDayDetail = () => toggleModal('day-detail-modal', false);
        window.switchView = (v) => { 
            document.getElementById('calendar-view-container').classList.toggle('hidden', v==='list'); 
            document.getElementById('list-view-container').classList.toggle('hidden', v==='calendar'); 
            document.getElementById('tab-calendar').classList.toggle('active', v==='calendar'); 
            document.getElementById('tab-list').classList.toggle('active', v==='list'); 
            // 需求 3：切換清單時隱藏全域統計卡片
            document.getElementById('global-stats-container').classList.toggle('hidden', v==='list');
        };
        
        window.switchListType = (t) => { 
            listType = t; 
            document.getElementById('subtab-month').className = 'text-gray-300 py-1.5 flex-1 rounded-full font-black text-xs';
            document.getElementById('subtab-year').className = 'text-gray-300 py-1.5 flex-1 rounded-full font-black text-xs';
            document.getElementById('subtab-stats').classList.remove('active');
            document.getElementById('subtab-repurchase').classList.remove('active');
            
            const filterRow = document.getElementById('repurchase-filters');
            filterRow.classList.toggle('hidden', t !== 'repurchase');

            if(t === 'month') document.getElementById('subtab-month').className = 'bg-white py-1.5 flex-1 rounded-full font-black shadow-sm text-xs';
            else if(t === 'year') document.getElementById('subtab-year').className = 'bg-white py-1.5 flex-1 rounded-full font-black shadow-sm text-xs';
            else if(t === 'stats') document.getElementById('subtab-stats').classList.add('active');
            else if(t === 'repurchase') {
                document.getElementById('subtab-repurchase').classList.add('active');
                setRepurchaseFilter(true); 
            }
            renderList(); 
        };

        window.clearForm = () => { 
            document.getElementById('input-shop').value = ''; document.getElementById('input-item').value = ''; document.getElementById('input-price').value = ''; document.getElementById('input-note').value = ''; selectedIce = ''; selectedSugar = ''; document.querySelectorAll('.chip-btn').forEach(c => c.classList.remove('selected')); 
            window.setRepurchase(null);
        };
        function updateChips(id, val) { Array.from(document.getElementById(id).children).forEach(c => c.classList.toggle('selected', c.innerText === val)); }
        function toggleModal(id, show) { const m = document.getElementById(id), c = document.getElementById(id + '-content'); if(show) { m.classList.remove('hidden'); setTimeout(()=> { m.classList.remove('opacity-0'); if(c) c.classList.remove('translate-y-full'); }, 10); } else { m.classList.add('opacity-0'); if(c) c.classList.add('translate-y-full'); setTimeout(()=> m.classList.add('hidden'), 300); } }
        const mkChip = (t, type) => { const b = document.createElement('button'); b.className = 'chip-btn'; b.innerText = t; b.onclick = (e) => { Array.from(e.target.parentElement.children).forEach(c=>c.classList.remove('selected')); e.target.classList.add('selected'); if(type==='ice') selectedIce=t; else selectedSugar=t; }; return b; };
        ['固定', '正常', '少冰', '微冰', '去冰', '溫', '熱'].forEach(o => document.getElementById('ice-options').appendChild(mkChip(o, 'ice')));
        ['固定', '全糖', '少糖', '半糖', '微糖', '一分糖', '無糖'].forEach(o => document.getElementById('sugar-options').appendChild(mkChip(o, 'sugar')));
        document.addEventListener('click', () => document.getElementById('settings-menu').classList.add('hidden'));
    </script>
</body>
</html>
