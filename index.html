<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 翊維飲料日記</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        /* 莫蘭迪色系預設 */
        :root { 
            --bg-color: #F2E9E4; 
            --theme-color: #9A8C98; 
            --text-color: #4A4E69; 
        }
        
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-color); color: var(--text-color); transition: all 0.3s ease; font-size: 14px; margin: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* 移除圓角 */
        * { border-radius: 0 !important; }

        .stat-card { background: white; padding: 12px; border: 1px solid rgba(0,0,0,0.05); }
        .stat-value { font-size: 1.6rem; font-weight: 900; color: var(--theme-color); line-height: 1.1; }
        
        /* 日曆 */
        .day-cell { aspect-ratio: 1/1; font-size: 14px; font-weight: 700; display: flex; align-items: center; justify-content: center; background: white; border: 1px solid #eee; position: relative; cursor: pointer; }
        .day-cell.today { outline: 2px solid var(--theme-color); z-index: 1; }
        .badge { position: absolute; top: 2px; right: 2px; background: var(--theme-color); color: white; font-size: 9px; padding: 2px 4px; font-weight: 900; }

        /* 滑動選單置中 */
        .swipe-item { position: relative; overflow: hidden; margin-bottom: 8px; border: 1px solid #eee; }
        .btn-action { position: absolute; top: 0; height: 100%; width: 64px; display: flex; align-items: center; justify-content: center; font-weight: 900; color: white; z-index: 1; }
        .btn-del { right: 0; background-color: #8E7D7D; } /* 莫蘭迪紅 */
        .btn-edit { left: 0; background-color: #7D8E87; } /* 莫蘭迪綠 */
        .swipe-content { position: relative; z-index: 10; background: white; transition: transform 0.2s ease-out; }
        
        /* 輸入框直角 */
        .input-box { border: 1px solid #ddd; padding: 10px; width: 100%; outline: none; }
        .input-box:focus { border-color: var(--theme-color); }
        .chip-btn { border: 1px solid #eee; padding: 6px 12px; font-size: 13px; font-weight: 700; background: white; margin-right: 4px; margin-bottom: 4px; }
        .chip-btn.selected { background-color: var(--theme-color) !important; color: white !important; }

        /* 設定面板樣式 */
        .theme-dot { width: 24px; height: 24px; display: inline-block; cursor: pointer; border: 1px solid #ddd; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden">

    <div id="loading-screen" class="fixed inset-0 bg-white z-[200] flex flex-col items-center justify-center font-black">
        <div class="w-10 h-10 border-4 border-gray-200 border-t-gray-500 animate-spin mb-4"></div>
        SYNCING...
    </div>

    <div class="flex-none p-4 pb-0 z-10 relative">
        <div class="flex justify-between items-start mb-3">
            <div>
                <h1 class="text-xl font-black flex items-center gap-2">
                    <span id="theme-icon" class="w-8 h-8 flex items-center justify-center text-white" style="background-color: var(--theme-color);"><i class="fas fa-mug-hot text-sm"></i></span>
                    <span>翊維飲料日記</span>
                </h1>
                <p class="text-[10px] font-black tracking-[0.2em] opacity-60 mt-0.5">DRINK DIARY 2026</p>
            </div>
            <button onclick="toggleModal('settings-modal', true)" class="w-9 h-9 bg-white shadow-sm flex items-center justify-center border border-gray-200">
                <i class="fas fa-cog text-lg"></i>
            </button>
        </div>

        <div class="grid grid-cols-2 gap-2 mb-3">
            <div class="stat-card">
                <div class="text-[11px] font-black opacity-40">本月累積 / 花費</div>
                <div class="stat-value"><span id="month-cups">0</span>杯 / <span id="month-cost">0</span>元</div>
            </div>
            <div class="stat-card">
                <div class="text-[11px] font-black opacity-40">年度累積 / 花費</div>
                <div class="stat-value"><span id="year-cups">0</span>杯 / <span id="year-cost">0</span>元</div>
            </div>
        </div>

        <div class="flex border-b border-gray-200">
            <button onclick="switchView('calendar')" id="tab-calendar" class="py-2 flex-1 font-black text-center border-b-2 border-transparent text-gray-300">日曆</button>
            <button onclick="switchView('list')" id="tab-list" class="py-2 flex-1 font-black text-center border-b-2 border-transparent text-gray-300">清單</button>
        </div>
    </div>

    <div id="calendar-view-container" class="flex flex-col flex-grow overflow-hidden">
        <div class="flex-none px-6 py-2 flex items-center justify-between">
            <button onclick="changeMonth(-1)" class="p-2"><i class="fas fa-chevron-left text-xl"></i></button>
            <h2 class="font-black text-lg" id="current-month-display">2026年 1月</h2>
            <button onclick="changeMonth(1)" class="p-2"><i class="fas fa-chevron-right text-xl"></i></button>
        </div>
        <div class="flex-grow overflow-y-auto px-4 pb-20 no-scrollbar">
            <div class="bg-white p-4 border border-gray-200">
                <div class="grid grid-cols-7 gap-1 mb-3 text-center text-[10px] font-black opacity-30">
                    <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
                </div>
                <div class="calendar-grid" id="calendar-grid"></div>
            </div>
        </div>
    </div>

    <div id="list-view-container" class="hidden flex flex-col flex-grow overflow-hidden">
        <div class="flex-none px-4 py-2 flex gap-2">
            <button onclick="switchListType('month')" id="subtab-month" class="px-4 py-1 border font-black text-xs">當月紀錄</button>
            <button onclick="switchListType('year')" id="subtab-year" class="px-4 py-1 border font-black text-xs">年度紀錄</button>
        </div>
        <div class="flex-grow overflow-y-auto px-4 pb-20 no-scrollbar" id="list-items-container"></div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/50 hidden z-[200] flex items-center justify-center p-6" onclick="if(event.target===this) toggleModal('settings-modal', false)">
        <div class="bg-white w-full max-w-sm p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-xl">系統設定</h3>
                <button onclick="toggleModal('settings-modal', false)"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="mb-6">
                <label class="text-xs font-black opacity-40 block mb-2">主題色切換 (莫蘭迪 & 少女色)</label>
                <div class="flex gap-3">
                    <div class="theme-dot" style="background:#9A8C98;" onclick="updateTheme('#9A8C98','#F2E9E4','#4A4E69')"></div>
                    <div class="theme-dot" style="background:#B7B7A4;" onclick="updateTheme('#B7B7A4','#FFE8D6','#6B705C')"></div>
                    <div class="theme-dot" style="background:#E5989B;" onclick="updateTheme('#E5989B','#FFCDB2','#6D6875')"></div>
                    <div class="theme-dot" style="background:#83A2FF;" onclick="updateTheme('#83A2FF','#ECF2FF','#445069')"></div>
                </div>
            </div>

            <div class="bg-gray-50 p-4 mb-6">
                <label class="text-[10px] font-black opacity-40 block uppercase">Account UID</label>
                <code id="user-uid" class="text-[10px] break-all block my-1">Loading...</code>
                <div class="text-[10px] text-green-600 font-bold"><i class="fas fa-sync-alt mr-1"></i> 雲端同步已開啟</div>
            </div>

            <button onclick="toggleModal('settings-modal', false)" class="w-full bg-black text-white py-3 font-black">確定並返回</button>
        </div>
    </div>

    <div id="day-detail-modal" class="fixed inset-0 bg-black/30 hidden items-end z-[100]" onclick="if(event.target === this) toggleModal('day-detail-modal', false)">
        <div class="bg-white w-full max-h-[70vh] flex flex-col" id="day-detail-modal-content">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center">
                <span class="font-black text-xl" id="detail-date-title"></span>
                <button onclick="toggleModal('day-detail-modal', false)"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div class="p-5 overflow-y-auto flex-grow no-scrollbar" id="day-records-list"></div>
        </div>
    </div>

    <div id="entry-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-6 z-[150]" onclick="if(event.target === this) closeEntryModal()">
        <div class="bg-white w-full max-w-sm flex flex-col shadow-2xl">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <span class="font-black text-xl" id="form-title">紀錄飲料</span>
                <button onclick="closeEntryModal()"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="p-6 space-y-4 max-h-[60vh] overflow-y-auto no-scrollbar">
                <input type="text" id="input-date-text" class="input-box font-black text-center" placeholder="YYYY/MM/DD">
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="input-shop" class="input-box" placeholder="店名">
                    <input type="text" id="input-item" class="input-box" placeholder="品項">
                </div>
                <input type="number" id="input-price" class="input-box text-xl font-black" placeholder="價格 $">
                
                <div>
                    <label class="text-[10px] font-black opacity-30 block mb-2">冰塊</label>
                    <div id="ice-options" class="flex flex-wrap"></div>
                </div>
                <div>
                    <label class="text-[10px] font-black opacity-30 block mb-2">甜度</label>
                    <div id="sugar-options" class="flex flex-wrap"></div>
                </div>
                <textarea id="input-note" class="input-box text-sm" placeholder="備註..." rows="2"></textarea>
            </div>

            <div class="p-6 grid grid-cols-2 gap-3">
                <button onclick="clearForm()" class="bg-gray-100 py-3 font-black text-xs">重置</button>
                <button id="save-btn" onclick="saveEntry()" class="text-white py-3 font-black" style="background: var(--theme-color);">儲存紀錄</button>
            </div>
        </div>
    </div>

    <button onclick="openQuickAdd()" class="fixed bottom-6 right-6 w-14 h-14 text-white flex items-center justify-center text-2xl z-40 shadow-xl active:scale-90 transition-transform" style="background: var(--theme-color);">
        <i class="fas fa-plus"></i>
    </button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyCLwMbIgQaF_KWYNWruOrHDrMopGJFx470", 
            appId: "1:994141313696:web:d14b3a97541fa6e0e207c5",
            authDomain: "drink-diary-2026.firebaseapp.com", 
            projectId: "drink-diary-2026"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.drinkDB = {};
        window.userSettings = { 
            themeColor: '#9A8C98', 
            bgColor: '#F2E9E4', 
            textColor: '#4A4E69' 
        };

        let currentMonth = new Date().getMonth(), currentViewingDate = '', listType = 'month', editingIdx = null, selectedIce = '', selectedSugar = '';

        onAuthStateChanged(auth, (user) => { 
            if (user) { 
                document.getElementById('user-uid').innerText = user.uid;
                startSync(user.uid); 
            } else { 
                signInAnonymously(auth); 
            } 
        });

        function startSync(uid) {
            onSnapshot(doc(db, 'artifacts', 'drink-diary-2026', 'users', uid), (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    window.drinkDB = data.records || {};
                    if(data.settings) window.userSettings = data.settings;
                }
                applyStyles(); renderAll(); 
                document.getElementById('loading-screen').classList.add('hidden');
            });
        }

        window.updateTheme = (theme, bg, text) => {
            window.userSettings = { themeColor: theme, bgColor: bg, textColor: text };
            applyStyles();
            saveToCloud();
        };

        function applyStyles() {
            document.documentElement.style.setProperty('--bg-color', window.userSettings.bgColor);
            document.documentElement.style.setProperty('--theme-color', window.userSettings.themeColor);
            document.documentElement.style.setProperty('--text-color', window.userSettings.textColor);
            document.body.style.backgroundColor = window.userSettings.bgColor;
            document.body.style.color = window.userSettings.textColor;
            document.getElementById('theme-icon').style.backgroundColor = window.userSettings.themeColor;
            document.getElementById('save-btn').style.backgroundColor = window.userSettings.themeColor;
        }

        async function saveToCloud() {
            const uid = auth.currentUser.uid;
            await setDoc(doc(db, 'artifacts', 'drink-diary-2026', 'users', uid), { 
                records: window.drinkDB, 
                settings: window.userSettings 
            }, { merge: true });
        }

        const YEAR = 2026;

        window.renderAll = () => {
            document.getElementById('current-month-display').innerText = `${YEAR}年 ${currentMonth+1}月`;
            updateStats(); renderCalendar(); renderList();
        };

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid'); grid.innerHTML = '';
            const firstDay = new Date(YEAR, currentMonth, 1).getDay();
            const totalDays = new Date(YEAR, currentMonth + 1, 0).getDate();
            const todayStr = new Date().toISOString().split('T')[0];

            for(let i=0; i<firstDay; i++) grid.appendChild(Object.assign(document.createElement('div'), {className:"day-cell border-transparent bg-transparent"}));
            for(let d=1; d<=totalDays; d++) {
                const ds = `${YEAR}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const records = window.drinkDB[ds] || [];
                const cell = document.createElement('div');
                cell.className = `day-cell ${ds === todayStr ? 'today' : ''}`;
                if(records.length > 0) cell.style.background = `${window.userSettings.themeColor}33`;
                cell.innerHTML = `<span>${d}</span>`;
                if(records.length > 0) cell.innerHTML += `<div class="badge">${records.length}</div>`;
                cell.onclick = () => { currentViewingDate = ds; if(records.length > 0) showDayDetail(ds); else openEntryForm(ds); };
                grid.appendChild(cell);
            }
        }

        window.showDayDetail = (ds) => { 
            document.getElementById('detail-date-title').innerText = ds.replace(/-/g, '/'); 
            const list = document.getElementById('day-records-list'); 
            list.innerHTML = ''; 
            (window.drinkDB[ds] || []).forEach((r, i) => list.appendChild(createSwipeItem(r, ds, i))); 
            toggleModal('day-detail-modal', true); 
        };

        function createSwipeItem(record, date, idx) {
            const wrapper = document.createElement('div'); wrapper.className = 'swipe-item';
            wrapper.innerHTML = `
                <div class="btn-action btn-del" onclick="delRec('${date}',${idx})">刪除</div>
                <div class="btn-action btn-edit" onclick="openEntryForm('${date}',${idx})">修正</div>
                <div class="swipe-content p-4 flex justify-between items-center">
                    <div>
                        <div class="text-[9px] font-black opacity-30 mb-0.5">${date.replace(/-/g, '/')}</div>
                        <div class="font-black text-base">${record.shop} · ${record.item}</div>
                        <div class="text-xs opacity-50 font-bold">${record.ice}/${record.sugar}</div>
                    </div>
                    <div class="text-xl font-black">$${record.price}</div>
                </div>`;
            
            const content = wrapper.querySelector('.swipe-content');
            let startX = 0, currentX = 0;
            content.ontouchstart = (e) => { startX = e.touches[0].pageX; content.style.transition = 'none'; };
            content.ontouchmove = (e) => { 
                currentX = e.touches[0].pageX - startX; 
                if(currentX < -64) currentX = -64; 
                if(currentX > 64) currentX = 64; 
                content.style.transform = `translateX(${currentX}px)`; 
            };
            content.ontouchend = () => { 
                content.style.transition = '0.2s'; 
                if(currentX < -32) content.style.transform = 'translateX(-64px)'; 
                else if(currentX > 32) content.style.transform = 'translateX(64px)'; 
                else content.style.transform = 'translateX(0px)'; 
            };
            return wrapper;
        }

        window.delRec = (d, i) => { if(confirm('確定刪除？')){ window.drinkDB[d].splice(i, 1); if(!window.drinkDB[d].length) delete window.drinkDB[d]; saveToCloud(); } };

        window.switchView = (v) => {
            document.getElementById('calendar-view-container').classList.toggle('hidden', v==='list');
            document.getElementById('list-view-container').classList.toggle('hidden', v==='calendar');
            document.getElementById('tab-calendar').className = `py-2 flex-1 font-black text-center border-b-2 ${v==='calendar' ? 'border-current' : 'border-transparent text-gray-300'}`;
            document.getElementById('tab-list').className = `py-2 flex-1 font-black text-center border-b-2 ${v==='list' ? 'border-current' : 'border-transparent text-gray-300'}`;
        };

        window.switchListType = (t) => {
            listType = t;
            document.getElementById('subtab-month').style.background = t==='month' ? 'white' : 'transparent';
            document.getElementById('subtab-year').style.background = t==='year' ? 'white' : 'transparent';
            renderList();
        };

        function renderList() {
            const container = document.getElementById('list-items-container'); container.innerHTML = '';
            let all = []; 
            const mPrefix = `${YEAR}-${String(currentMonth+1).padStart(2,'0')}`;
            Object.keys(window.drinkDB).forEach(d => { 
                if (listType === 'month' && !d.startsWith(mPrefix)) return; 
                window.drinkDB[d].forEach((r, i) => all.push({...r, date: d, idx: i})); 
            });
            all.sort((a,b) => b.date.localeCompare(a.date));
            all.forEach(r => container.appendChild(createSwipeItem(r, r.date, r.idx)));
        }

        window.updateStats = () => {
            let mc=0, m$=0, yc=0, y$=0; 
            const mPrefix = `${YEAR}-${String(currentMonth+1).padStart(2,'0')}`;
            Object.keys(window.drinkDB).forEach(d => { 
                window.drinkDB[d].forEach(r => { 
                    const p = parseInt(r.price)||0; yc++; y$+=p; 
                    if(d.startsWith(mPrefix)) { mc++; m$+=p; } 
                }); 
            });
            document.getElementById('month-cups').innerText = mc; 
            document.getElementById('month-cost').innerText = m$; 
            document.getElementById('year-cups').innerText = yc; 
            document.getElementById('year-cost').innerText = y$;
        };

        window.toggleModal = (id, show) => { document.getElementById(id).classList.toggle('hidden', !show); if(show && id==='day-detail-modal') document.getElementById(id).style.display='flex'; };
        window.changeMonth = (d) => { currentMonth = (currentMonth+d+12)%12; renderAll(); };
        window.openQuickAdd = () => openEntryForm(new Date().toISOString().split('T')[0]);
        window.closeEntryModal = () => toggleModal('entry-modal', false);

        window.openEntryForm = (ds, idx = null) => {
            editingIdx = idx;
            document.getElementById('input-date-text').value = ds.replace(/-/g, '/');
            clearForm();
            if(idx !== null) {
                const r = window.drinkDB[ds][idx];
                document.getElementById('input-shop').value = r.shop;
                document.getElementById('input-item').value = r.item;
                document.getElementById('input-price').value = r.price;
                document.getElementById('input-note').value = r.note || '';
                selectedIce = r.ice; selectedSugar = r.sugar;
                updateChipUI();
            }
            toggleModal('entry-modal', true);
            toggleModal('day-detail-modal', false);
        };

        window.saveEntry = () => {
            const date = document.getElementById('input-date-text').value.replace(/\//g, '-');
            const data = {
                shop: document.getElementById('input-shop').value,
                item: document.getElementById('input-item').value,
                price: document.getElementById('input-price').value,
                ice: selectedIce, sugar: selectedSugar,
                note: document.getElementById('input-note').value
            };
            if(!data.shop || !data.item || !data.price) return alert('必填未齊');
            if(!window.drinkDB[date]) window.drinkDB[date] = [];
            if(editingIdx !== null) window.drinkDB[date][editingIdx] = data;
            else window.drinkDB[date].push(data);
            saveToCloud();
            closeEntryModal();
        };

        window.clearForm = () => { 
            document.querySelectorAll('#entry-modal input').forEach(i => { if(i.id!=='input-date-text') i.value=''; });
            selectedIce = ''; selectedSugar = ''; updateChipUI();
        };

        const iceOpts = ['固定', '少冰', '去冰', '微冰', '熱'], sugarOpts = ['固定', '半糖', '微糖', '無糖', '全糖'];
        function initChips(id, opts, type) {
            const container = document.getElementById(id);
            opts.forEach(o => {
                const b = document.createElement('button');
                b.className = 'chip-btn'; b.innerText = o;
                b.onclick = () => { 
                    if(type==='ice') selectedIce = o; else selectedSugar = o; 
                    updateChipUI();
                };
                container.appendChild(b);
            });
        }
        function updateChipUI() {
            document.querySelectorAll('.chip-btn').forEach(b => {
                b.classList.toggle('selected', b.innerText === selectedIce || b.innerText === selectedSugar);
            });
        }
        initChips('ice-options', iceOpts, 'ice');
        initChips('sugar-options', sugarOpts, 'sugar');

        // 初始化視圖
        switchView('calendar');
    </script>
</body>
</html>
